<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLS - MLX Serving</title>
    <meta name="description" content="Local ML inference dashboard: ASR, TTS, Translation, Image Generation, Vision - powered by MLX on Apple Silicon.">
    <meta property="og:title" content="MLS - MLX Serving">
    <meta property="og:description" content="Local ML inference dashboard: ASR, TTS, Translation, Image Generation, Vision - powered by MLX on Apple Silicon.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://github.com/hanxiao/mls">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="MLS - MLX Serving">
    <meta name="twitter:description" content="Local ML inference dashboard powered by MLX on Apple Silicon.">
    <meta name="theme-color" content="#e25f4a">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 14 14'%3E%3Crect x='2' y='3' width='2' height='2' fill='%23e25f4a'/%3E%3Crect x='10' y='3' width='2' height='2' fill='%23e25f4a'/%3E%3Crect x='3' y='5' width='8' height='6' fill='%23e25f4a'/%3E%3Crect x='2' y='6' width='10' height='4' fill='%23e25f4a'/%3E%3Crect x='4' y='7' width='1' height='1' fill='%23fff'/%3E%3Crect x='9' y='7' width='1' height='1' fill='%23fff'/%3E%3Crect x='6' y='8' width='2' height='1' fill='rgba(255,255,255,0.4)'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ========== Design Principles ==========
         * Icons: all outline style, stroke="currentColor" fill="none".
         *   Main (24x24 viewBox): stroke-width 2, round caps/joins.
         *   Sidebar micro (10x10 viewBox): stroke-width 1.5.
         * Button groups:
         *   .toggle-btn  - Selection/toggle (sort, speed, theme, ctrl).
         *                  surface bg, border, text-2. Hover: accent border+text. Active: accent fill, white text.
         *   .action-btn  - Primary CTA (synthesize, translate, generate, analyze).
         *                  accent bg, white text. Hover: accent-hover. Disabled: text-3 bg.
         *   .ghost-btn   - Secondary (play, download, swap).
         *                  transparent bg, border, text-2. Hover: accent border+text.
         *   .icon-btn    - Sidebar micro (pause, restart). Transparent, minimal hover.
         * Shared: border-radius 3px, transition all 0.15s, JetBrains Mono.
         * Colors: accent #e25f4a, status green #22c55e, warning #eab308, error #ef4444.
         */

        /* ========== Theme variables ========== */
        :root {
            --sb-bg: #f3f4f6; --sb-text: #1a1f36; --sb-text-2: #6b7280; --sb-text-3: #9ca3af;
            --sb-text-4: #c0c4cc; --sb-border: rgba(0,0,0,0.07); --sb-hover: rgba(0,0,0,0.03);
            --sb-active-bg: rgba(226,95,74,0.07); --sb-input-bg: #fff; --sb-input-border: rgba(0,0,0,0.12);
            --sb-select-opt-bg: #fff; --sb-bar-track: rgba(0,0,0,0.06); --sb-bar-idle: #c0c4cc;
            --bg: #fafafa; --surface: #fff; --surface-alt: #f5f6f8; --text: #1a1f36; --text-2: #6b7280;
            --text-3: #9ca3af; --border: #e0e2e8; --border-light: #ecedf0;
            --accent: #e25f4a; --accent-hover: #d04a35; --accent-bg: #fef2f0;
            --badge-blue: #e8f4fd; --badge-green: #f0fdf4; --badge-purple: #f0e6ff; --badge-gray: #f3f4f6;
            --waveform-bg: #f0f1f4;
        }
        [data-theme="dark"] {
            --sb-bg: #13152a; --sb-text: #c8cde0; --sb-text-2: #6b7290; --sb-text-3: #454a68;
            --sb-text-4: #2e3250; --sb-border: rgba(255,255,255,0.06); --sb-hover: rgba(255,255,255,0.03);
            --sb-active-bg: rgba(226,95,74,0.1); --sb-input-bg: rgba(255,255,255,0.04); --sb-input-border: rgba(255,255,255,0.1);
            --sb-select-opt-bg: #13152a; --sb-bar-track: rgba(255,255,255,0.06); --sb-bar-idle: #3a4060;
            --bg: #0e1020; --surface: #181a2e; --surface-alt: #1e2038; --text: #d0d4e4; --text-2: #7a80a0;
            --text-3: #4a5070; --border: #282c44; --border-light: #222640;
            --accent: #e25f4a; --accent-hover: #f06a55; --accent-bg: rgba(226,95,74,0.15);
            --badge-blue: rgba(100,160,220,0.15); --badge-green: rgba(80,200,120,0.12); --badge-purple: rgba(160,120,240,0.12); --badge-gray: rgba(255,255,255,0.06);
            --waveform-bg: #1a1d30;
        }

        /* ========== Base ========== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--text); font-size: 14px; transition: background 0.2s, color 0.2s; }
        .container { display: flex; height: 100vh; }

        /* ========== Sidebar ========== */
        .sidebar { width: 200px; background: var(--sb-bg); display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid var(--sb-border); transition: background 0.2s; }
        .logo { padding: 14px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--sb-border); }
        .logo svg { width: 22px; height: 22px; }
        .logo-text { font-weight: 600; font-size: 13px; color: var(--sb-text); }
        .service-rows { border-bottom: 1px solid var(--sb-border); }
        .service-row { border-bottom: 1px solid var(--sb-border); cursor: pointer; transition: background 0.15s; }
        .service-row:last-child { border-bottom: none; }
        .service-row:hover { background: var(--sb-hover); }
        .service-row.active { background: var(--sb-active-bg); border-left: 2px solid var(--accent); }
        @keyframes svc-flash { 0%,100% { box-shadow: inset 0 0 0 0 transparent; } 20%,80% { box-shadow: inset 200px 0 0 0 var(--accent-bg); } }
        .service-row.new-item { animation: svc-flash 3s ease; }
        .svc-header-actions { margin-left: auto; display: none; gap: 2px; }
        .service-row.expanded .svc-header-actions { display: flex; }
        .icon-btn { background: none; border: 1px solid transparent; color: var(--sb-text-3); font-size: 10px; width: 18px; height: 18px; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; transition: all 0.15s; }
        .icon-btn:hover { color: var(--sb-text-2); border-color: var(--sb-input-border); }
        .icon-btn:active { color: var(--accent); border-color: var(--accent); }
        .icon-btn svg { width: 10px; height: 10px; }
        .service-row-header { padding: 7px 12px 4px; display: flex; align-items: center; gap: 6px; }
        .service-row.active .service-row-header { padding-left: 10px; }
        .service-row-name { font-weight: 500; font-size: 11px; color: var(--sb-text-2); text-transform: uppercase; letter-spacing: 0.3px; flex: 1; }
        .service-row.active .service-row-name { color: var(--sb-text); }
        .service-row-model { padding: 0 12px 6px; font-size: 9px; color: var(--sb-text-3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .service-row.active .service-row-model { padding-left: 10px; color: var(--sb-text-2); }
        .service-row-details { display: none; padding: 0 12px 8px; }
        .service-row.active .service-row-details { padding-left: 10px; }
        .service-row.expanded .service-row-details { display: block; }
        .service-row-details .model-name-full { color: var(--sb-text-2); font-size: 9px; margin-bottom: 6px; word-break: break-all; line-height: 1.4; }
        .service-row-details .model-select { width: 100%; margin-bottom: 6px; padding: 4px 5px; background: var(--sb-input-bg); border: 1px solid var(--sb-input-border); border-radius: 2px; color: var(--sb-text-2); font-size: 9px; font-family: 'JetBrains Mono', monospace; cursor: pointer; }
        .service-row-details .model-select:focus { outline: none; border-color: var(--accent); }
        .service-row-details .model-select option { background: var(--sb-select-opt-bg); color: var(--sb-text); }
        .service-row-details .model-controls { display: flex; gap: 4px; margin-bottom: 6px; }
        .service-row-details .svc-stats { font-size: 9px; color: var(--sb-text-3); line-height: 1.6; }
        .service-row-details .svc-stats span { color: var(--accent); font-size: 9px; }
        .sidebar-content { margin-top: auto; }

        /* Calendar */
        .mini-calendar { padding: 6px 10px 10px; border-top: 1px solid var(--sb-border); }
        .cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
        .cal-nav button { background: none; border: none; color: var(--sb-text-3); font: 10px 'JetBrains Mono', monospace; cursor: pointer; padding: 2px 4px; }
        .cal-nav button:hover { color: var(--sb-text); }
        .cal-nav .cal-month { color: var(--sb-text-2); font: 10px 'JetBrains Mono', monospace; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0; text-align: center; }
        .cal-header { color: var(--sb-text-3); font: 8px 'JetBrains Mono', monospace; padding: 2px 0; }
        .cal-day { font: 10px 'JetBrains Mono', monospace; padding: 2px 0; border-radius: 2px; color: var(--sb-text-4); cursor: default; user-select: none; }
        .cal-day.has-data { color: var(--sb-text-2); cursor: pointer; }
        .cal-day.has-data:hover { background: var(--sb-hover); color: var(--sb-text); }
        .cal-day.active { background: var(--accent); color: #fff !important; }
        .cal-day.today:not(.active) { border-bottom: 1px solid var(--accent); }

        /* GPU stats */
        .gpu-stats { padding: 8px 10px; border-top: 1px solid var(--sb-border); }
        .gpu-stats-title { font-size: 9px; font-weight: 500; color: var(--sb-text-3); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 6px; }
        .gpu-bar-row { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; }
        .gpu-bar-label { width: 32px; flex-shrink: 0; color: var(--sb-text-3); font-size: 8px; text-transform: uppercase; letter-spacing: 0.3px; }
        .gpu-bar-track { flex: 1; height: 3px; background: var(--sb-bar-track); border-radius: 2px; overflow: hidden; }
        .gpu-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; background: var(--sb-bar-idle); }
        .gpu-bar-fill.hot { background: #e25f4a; }
        .gpu-bar-fill.warm { background: #eab308; }
        .gpu-bar-fill.cool { background: #22c55e; }
        .gpu-bar-value { width: 28px; text-align: right; flex-shrink: 0; color: var(--sb-text-3); font-size: 8px; }

        /* Log chart */
        .log-chart-wrap { padding: 6px 10px; border-top: 1px solid var(--sb-border); cursor: pointer; }
        .log-chart-wrap:hover { background: var(--sb-hover); }
        .log-chart-wrap.active { background: var(--sb-hover); border-left: 2px solid var(--accent); padding-left: 8px; }
        .log-chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
        .log-chart-title { font-size: 9px; font-weight: 500; color: var(--sb-text-3); text-transform: uppercase; letter-spacing: 0.3px; }
        .log-chart-count { font-size: 8px; color: var(--sb-text-3); }
        .log-chart { display: flex; align-items: flex-end; gap: 1px; height: 18px; }
        .log-chart-bar { flex: 1; min-width: 1px; background: var(--accent); opacity: 0.5; border-radius: 1px 1px 0 0; transition: height 0.3s ease; }
        .log-chart-bar.has-data { opacity: 0.8; }
        /* Log panel */
        .log-panel { flex-direction: column; overflow: hidden !important; padding: 0 !important; }
        .log-panel .header { flex-shrink: 0; padding: 16px 24px; }
        .log-body { flex: 1; overflow-y: auto; padding: 0 24px 16px; font-size: 11px; line-height: 1.6; color: var(--text-2); white-space: pre-wrap; word-break: break-all; }
        .log-line-info { color: var(--text-2); }
        .log-line-error { color: #ef4444; font-weight: 500; }
        .log-line-warning { color: #eab308; }
        .log-status { font-size: 10px; color: var(--text-3); padding: 2px 8px; }

        /* Theme toggle */
        .theme-toggle { padding: 6px 10px 8px; border-top: 1px solid var(--sb-border); display: flex; align-items: center; gap: 4px; }
        .theme-btn { flex: 1; background: none; border: 1px solid var(--sb-border); border-radius: 3px; color: var(--sb-text-3); font: 8px 'JetBrains Mono', monospace; padding: 3px 0; cursor: pointer; text-align: center; transition: all 0.15s; }
        .theme-btn:hover { color: var(--sb-text-2); border-color: var(--sb-input-border); }
        .theme-btn:active { background: var(--accent-bg); }
        .theme-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
        .uptime-widget { padding: 6px 10px; border-top: 1px solid var(--sb-border); display: flex; align-items: center; gap: 6px; }
        .uptime-label { font-size: 8px; color: var(--sb-text-3); text-transform: uppercase; letter-spacing: 0.3px; }
        .uptime-value { font-size: 8px; color: var(--sb-text-2); flex: 1; }
        .restart-btn { background: none; border: 1px solid var(--sb-border); border-radius: 3px; color: var(--sb-text-3); font: 8px 'JetBrains Mono', monospace; padding: 2px 6px; cursor: pointer; transition: all 0.15s; }
        .restart-btn:hover { color: var(--accent); border-color: var(--accent); }

        /* Sidebar misc */
        .sidebar-sub { display: none; }
        .dates-container { flex: 1; overflow-y: auto; padding: 6px 0; }
        .date-item { padding: 6px 14px; cursor: pointer; color: var(--sb-text-2); font-size: 11px; transition: all 0.15s; }
        .date-item:hover { color: var(--sb-text); background: var(--sb-hover); }
        .date-item.active { color: #fff; background: var(--accent); }

        /* Status dots */
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #22c55e; flex-shrink: 0; }
        .status-dot.paused { background: #eab308; animation: none; }
        .status-dot.loading { background: #eab308; animation: pulse 0.8s infinite; }
        .status-dot.error { background: #ef4444; animation: none; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        .ctrl-btn { background: var(--sb-input-bg); border: 1px solid var(--sb-input-border); border-radius: 3px; color: var(--sb-text-2); padding: 3px 6px; font-size: 9px; font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s; }
        .ctrl-btn:hover { border-color: var(--accent); color: var(--accent); }
        .ctrl-btn:active { background: var(--accent-bg); }
        .ctrl-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

        /* ========== Main content ========== */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .main-content { flex: 1; overflow-y: auto; padding: 30px 40px; }
        .header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .header-controls { display: flex; align-items: center; gap: 12px; }
        .header h2 { font-size: 13px; font-weight: 500; color: var(--text-2); text-transform: uppercase; letter-spacing: 0.5px; }

        .sort-controls { display: flex; gap: 6px; align-items: center; }
        .sort-label { font-size: 11px; color: var(--text-3); }
        .sort-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text-2); padding: 4px 10px; font-size: 11px; font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 4px; border-radius: 3px; }
        .sort-btn:hover { border-color: var(--accent); color: var(--accent); }
        .sort-btn:active { background: var(--accent-bg); }
        .sort-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
        .sort-btn svg { width: 10px; height: 10px; transition: transform 0.2s ease; }

        .speed-controls { display: flex; gap: 4px; align-items: center; margin-left: 8px; }
        .speed-label { font-size: 11px; color: var(--text-3); margin-right: 4px; }
        .speed-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text-2); padding: 4px 8px; font-size: 11px; font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s; min-width: 28px; text-align: center; border-radius: 3px; }
        .speed-btn:hover { border-color: var(--accent); color: var(--accent); }
        .speed-btn:active { background: var(--accent-bg); }
        .speed-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

        /* Cards */
        .transcript { background: var(--surface); border: 1px solid var(--border); padding: 16px 20px; margin-bottom: 12px; transition: border-color 0.15s; border-radius: 3px; }
        .transcript:hover { border-color: var(--accent); }
        .transcript-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .transcript-time { color: var(--text-2); font-size: 12px; }
        .transcript-latency { color: var(--accent); font-size: 11px; padding: 2px 6px; background: var(--accent-bg); border-radius: 3px; display: flex; align-items: center; gap: 4px; }
        .transcript-latency svg { width: 12px; height: 12px; }
        .transcript-model { color: var(--text-2); font-size: 10px; padding: 2px 6px; background: var(--badge-gray); border-radius: 3px; margin-left: auto; }
        .transcript-text { font-size: 15px; line-height: 1.6; color: var(--text); }
        .transcript-footer { display: flex; align-items: center; gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light); }
        .transcript-file { color: var(--text-3); font-size: 11px; flex: 1; }
        .play-btn { background: transparent; color: var(--text-2); border: 1px solid var(--border); padding: 6px 14px; cursor: pointer; font-size: 12px; font-family: 'JetBrains Mono', monospace; display: flex; align-items: center; gap: 6px; transition: all 0.15s; border-radius: 3px; text-decoration: none; }
        .play-btn:hover { border-color: var(--accent); color: var(--accent); }
        .play-btn:active { background: var(--accent-bg); }
        .play-btn svg { width: 12px; height: 12px; }

        .waveform-container { position: relative; height: 48px; margin-top: 12px; background: var(--waveform-bg); border-radius: 4px; cursor: pointer; overflow: hidden; }
        .waveform-container canvas { display: block; width: 100%; height: 100%; }
        .waveform-progress { position: absolute; top: 0; left: 0; height: 100%; background: rgba(226,95,74,0.15); pointer-events: none; transition: width 0.1s linear; }
        .waveform-time { position: absolute; bottom: 4px; right: 8px; font-size: 10px; color: var(--text-2); pointer-events: none; }
        .waveform-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 11px; color: var(--text-3); }
        audio { display: none; }
        .empty { color: var(--text-3); text-align: center; padding: 60px 40px; border: 1px solid var(--border); background: var(--surface); border-radius: 3px; }

        /* Panels */
        .tts-panel { display: none; } .tts-panel.active { display: block; }
        .asr-panel { display: block; } .translate-panel { display: none; }
        .image-panel { display: none; } .vision-panel { display: none; } .log-panel { display: none; }

        /* Compose panel (right column) */
        .compose-panel { width: 350px; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; transition: background 0.2s; }
        .compose-panel.collapsed { width: 0; min-width: 0; border: none; }
        .compose-panel-header { padding: 10px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .compose-panel-title { font-size: 11px; font-weight: 500; color: var(--text-2); text-transform: uppercase; letter-spacing: 0.5px; }
        .compose-panel-body { flex: 1; overflow-y: auto; padding: 16px; }
        .compose-content { display: none; }
        .compose-content.active { display: block; }
        .compose-open-strip { width: 20px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: var(--surface); border-left: 1px solid var(--border); cursor: pointer; color: var(--text-3); transition: all 0.15s; }
        .compose-open-strip:hover { color: var(--accent); background: var(--accent-bg); }
        .resize-handle { width: 4px; cursor: col-resize; background: transparent; flex-shrink: 0; transition: background 0.15s; }
        .resize-handle:hover { background: var(--border); }
        .resize-handle.active { background: var(--accent); }

        /* Compose areas (inside compose panel) */
        .tts-compose, .translate-compose, .image-compose, .vision-compose { margin-bottom: 0; }
        .file-translate-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
        .tts-compose-header, .translate-compose-header { font-size: 11px; font-weight: 500; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .tts-textarea, .translate-textarea { width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.6; resize: vertical; color: var(--text); background: var(--surface-alt); border-radius: 2px; }
        .tts-textarea:focus, .translate-textarea:focus { outline: none; border-color: var(--accent); }
        .translate-textarea[readonly] { background: var(--surface-alt); color: var(--text-2); }
        .tts-controls, .translate-controls { display: flex; align-items: center; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .tts-select, .translate-select { padding: 8px 12px; border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text); background: var(--surface); cursor: pointer; border-radius: 2px; }
        .tts-select:focus, .translate-select:focus { outline: none; border-color: var(--accent); }
        .translate-select { max-width: 180px; }
        .synthesize-btn { background: var(--accent); color: #fff; border: none; padding: 8px 20px; font-size: 12px; font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 6px; border-radius: 3px; }
        .synthesize-btn:hover { background: var(--accent-hover); }
        .synthesize-btn:active { filter: brightness(0.9); }
        .synthesize-btn:disabled { background: var(--text-3); cursor: not-allowed; filter: none; }
        .synthesize-btn svg { width: 14px; height: 14px; }
        .tts-speed-input { width: 60px; padding: 8px; border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 12px; text-align: center; color: var(--text); background: var(--surface); border-radius: 2px; }
        .tts-speed-input:focus { outline: none; border-color: var(--accent); }
        .swap-btn { background: transparent; border: 1px solid var(--border); color: var(--text-2); padding: 8px 12px; font-size: 14px; cursor: pointer; transition: all 0.15s; border-radius: 3px; }
        .swap-btn:hover { border-color: var(--accent); color: var(--accent); }
        .swap-btn:active { background: var(--accent-bg); }
        .translate-output-label { font-size: 11px; color: var(--text-3); margin-top: 16px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .file-translate-controls { display: flex; align-items: center; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .file-input { flex: 1; padding: 8px 12px; border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text); background: var(--surface-alt); border-radius: 2px; }
        .file-input:focus { outline: none; border-color: var(--accent); }
        .file-progress { margin-top: 12px; font-size: 11px; color: var(--text-2); }
        .file-progress-bar { height: 4px; background: var(--border-light); border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .file-progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; }

        /* History items */
        .tts-item, .translate-item, .image-item, .vision-item { background: var(--surface); border: 1px solid var(--border); padding: 16px 20px; margin-bottom: 12px; transition: border-color 0.15s; border-radius: 3px; }
        .tts-item:hover, .translate-item:hover, .image-item:hover, .vision-item:hover { border-color: var(--accent); }
        .image-item, .vision-item { padding: 16px; display: flex; gap: 16px; align-items: flex-start; }
        .tts-voice-badge { color: var(--text-2); font-size: 10px; padding: 2px 6px; background: var(--badge-blue); border-radius: 3px; }
        .tts-lang-badge { color: var(--text-2); font-size: 10px; padding: 2px 6px; background: var(--badge-green); border-radius: 3px; }
        .translate-lang-badge { color: var(--text-2); font-size: 10px; padding: 2px 6px; background: var(--badge-purple); border-radius: 3px; }
        .translate-arrow { color: var(--text-3); font-size: 11px; }
        .translate-source-text { font-size: 13px; line-height: 1.5; color: var(--text-2); margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border-light); }
        .translate-result-text { font-size: 15px; line-height: 1.6; color: var(--text); }

        /* Image panel */
        .image-result { margin-top: 20px; text-align: center; border-top: 1px solid var(--border-light); padding-top: 20px; }
        .image-result img { max-width: 100%; max-height: 500px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .image-item-thumb, .vision-item-thumb { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; background: var(--surface-alt); cursor: pointer; }
        .vision-item-thumb { flex-shrink: 0; }
        .img-broken { display: none; }
        .image-item-details, .vision-item-details { flex: 1; }
        .image-item-prompt { font-size: 13px; line-height: 1.5; color: var(--text); margin-bottom: 8px; }
        .image-item-meta { font-size: 11px; color: var(--text-2); display: flex; gap: 12px; align-items: center; }

        /* Vision panel */
        .vision-upload-area { display: flex; flex-direction: column; gap: 12px; }
        .vision-preview { width: 100%; height: 140px; border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-3); font-size: 11px; background: var(--surface-alt); overflow: hidden; flex-shrink: 0; }
        .vision-preview img { width: 100%; height: 100%; object-fit: cover; }
        .vision-inputs { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .vision-response { font-size: 13px; line-height: 1.6; color: var(--text); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-light); white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <a class="logo" href="https://github.com/hanxiao/mls" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">
                <svg width="28" height="28" viewBox="0 0 14 14" shape-rendering="crispEdges">
                    <rect x="2" y="3" width="2" height="2" fill="#e25f4a"/>
                    <rect x="10" y="3" width="2" height="2" fill="#e25f4a"/>
                    <rect x="3" y="5" width="8" height="6" fill="#e25f4a"/>
                    <rect x="2" y="6" width="10" height="4" fill="#e25f4a"/>
                    <rect x="4" y="7" width="1" height="1" fill="var(--sb-bg)"/>
                    <rect x="9" y="7" width="1" height="1" fill="var(--sb-bg)"/>
                    <rect x="6" y="8" width="2" height="1" fill="rgba(255,255,255,0.4)"/>
                    <rect x="3" y="5" width="1" height="1" fill="rgba(255,255,255,0.2)"/>
                </svg>
                <span class="logo-text" style="font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; font-weight: 700;">MLS</span>
            </a>

            <!-- Service accordion rows -->
            <div class="service-rows">
                <!-- ASR row -->
                <div class="service-row active expanded" id="svc-row-asr" onclick="onServiceRowClick(event, 'asr')">
                    <div class="service-row-header">
                        <div class="status-dot loading" id="status-dot"></div>
                        <span class="service-row-name">ASR</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="btn-pause" onclick="togglePause()" title="pause"><svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="3" y1="2" x2="3" y2="8"/><line x1="7" y1="2" x2="7" y2="8"/></svg></button>
                            <button class="icon-btn" id="btn-restart" onclick="restartModel()" title="restart"><svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 5a3.5 3.5 0 1 1-3.5-3.5"/><polyline points="3.5,0 5,1.5 3.5,3"/></svg></button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-asr">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="model-name-full" id="model-name" style="display:none">-</div>
                        <select class="model-select" id="model-select" onchange="switchModel(this.value)"></select>
                        <div class="svc-stats">
                            <div>total: <span id="stat-total">-</span> / <span id="stat-total-duration">-</span></div>
                            <div>today: <span id="stat-today">-</span> / <span id="stat-today-duration">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- TTS row -->
                <div class="service-row" id="svc-row-tts" onclick="onServiceRowClick(event, 'tts')">
                    <div class="service-row-header">
                        <div class="status-dot loading" id="tts-status-dot"></div>
                        <span class="service-row-name">TTS</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="tts-btn-pause" onclick="toggleTTSPause()" title="pause"><svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="3" y1="2" x2="3" y2="8"/><line x1="7" y1="2" x2="7" y2="8"/></svg></button>
                            <button class="icon-btn" id="tts-btn-restart" onclick="restartTTSModel()" title="restart"><svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 5a3.5 3.5 0 1 1-3.5-3.5"/><polyline points="3.5,0 5,1.5 3.5,3"/></svg></button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-tts">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="model-name-full" id="tts-model-name" style="display:none">-</div>
                        <select class="model-select" id="tts-model-select" onchange="switchTTSModel(this.value)"></select>
                        <div class="svc-stats">
                            <div>total: <span id="tts-stat-total">-</span> / <span id="tts-stat-total-duration">-</span></div>
                            <div>today: <span id="tts-stat-today">-</span> / <span id="tts-stat-today-duration">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Translate row -->
                <div class="service-row" id="svc-row-translate" onclick="onServiceRowClick(event, 'translate')">
                    <div class="service-row-header">
                        <div class="status-dot loading" id="translate-status-dot"></div>
                        <span class="service-row-name">Translate</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="translate-btn-pause" onclick="toggleTranslatePause()" title="pause"><svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="3" y1="2" x2="3" y2="8"/><line x1="7" y1="2" x2="7" y2="8"/></svg></button>
                            <button class="icon-btn" id="translate-btn-restart" onclick="restartTranslateModel()" title="restart"><svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 5a3.5 3.5 0 1 1-3.5-3.5"/><polyline points="3.5,0 5,1.5 3.5,3"/></svg></button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-translate">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="model-name-full" id="translate-model-name" style="display:none">-</div>
                        <div class="svc-stats">
                            <div>total: <span id="translate-stat-total">-</span></div>
                            <div>today: <span id="translate-stat-today">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Image row -->
                <div class="service-row" id="svc-row-image" onclick="onServiceRowClick(event, 'image')">
                    <div class="service-row-header">
                        <div class="status-dot loading" id="image-status-dot"></div>
                        <span class="service-row-name">Image</span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-image">z-image-turbo-8bit</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="svc-stats">
                            <div>total: <span id="image-stat-total">-</span></div>
                            <div>today: <span id="image-stat-today">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Vision row -->
                <div class="service-row" id="svc-row-vision" onclick="onServiceRowClick(event, 'vision')">
                    <div class="service-row-header">
                        <div class="status-dot loading" id="vision-status-dot"></div>
                        <span class="service-row-name">Vision</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="vision-btn-pause" onclick="toggleVisionPause()" title="pause"><svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="3" y1="2" x2="3" y2="8"/><line x1="7" y1="2" x2="7" y2="8"/></svg></button>
                            <button class="icon-btn" id="vision-btn-restart" onclick="restartVisionModel()" title="restart"><svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 5a3.5 3.5 0 1 1-3.5-3.5"/><polyline points="3.5,0 5,1.5 3.5,3"/></svg></button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-vision">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="svc-stats">
                            <div>total: <span id="vision-stat-total">-</span></div>
                            <div>today: <span id="vision-stat-today">-</span></div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="sidebar-content">
                <div class="mini-calendar" id="mini-calendar">
                    <div class="cal-nav">
                        <button onclick="calPrevMonth()">&lt;</button>
                        <span class="cal-month" id="cal-month-label"></span>
                        <button onclick="calNextMonth()">&gt;</button>
                    </div>
                    <div class="cal-grid" id="cal-grid"></div>
                </div>

                <div class="gpu-stats" id="gpu-stats">
                    <div class="gpu-stats-title" id="gpu-device-name">GPU</div>
                    <div class="gpu-bar-row">
                        <span class="gpu-bar-label">load</span>
                        <div class="gpu-bar-track"><div class="gpu-bar-fill" id="gpu-util-bar" style="width:0%"></div></div>
                        <span class="gpu-bar-value" id="gpu-util-val">--%</span>
                    </div>
                    <div class="gpu-bar-row">
                        <span class="gpu-bar-label">mem</span>
                        <div class="gpu-bar-track"><div class="gpu-bar-fill" id="gpu-mem-bar" style="width:0%"></div></div>
                        <span class="gpu-bar-value" id="gpu-mem-val">--</span>
                    </div>
                    <div class="gpu-bar-row">
                        <span class="gpu-bar-label">disk</span>
                        <div class="gpu-bar-track"><div class="gpu-bar-fill" id="disk-bar" style="width:0%"></div></div>
                        <span class="gpu-bar-value" id="disk-val">--</span>
                    </div>
                    <div class="gpu-bar-row" id="usb-bar-row" style="display:none;">
                        <span class="gpu-bar-label">usb</span>
                        <div class="gpu-bar-track"><div class="gpu-bar-fill" id="usb-bar" style="width:0%"></div></div>
                        <span class="gpu-bar-value" id="usb-val">--</span>
                    </div>
                    <div class="gpu-bar-row">
                        <span class="gpu-bar-label">queue</span>
                        <div class="gpu-bar-track"><div class="gpu-bar-fill cool" id="queue-bar" style="width:0%"></div></div>
                        <span class="gpu-bar-value" id="queue-val">0</span>
                    </div>
                </div>

                <div class="log-chart-wrap" onclick="switchTab('log')" title="Server logs - last 1h">
                    <div class="log-chart-header">
                        <span class="log-chart-title">log</span>
                        <span class="log-chart-count" id="log-chart-count">--</span>
                    </div>
                    <div class="log-chart" id="log-chart"></div>
                </div>

                <div class="uptime-widget">
                    <span class="uptime-label">uptime</span>
                    <span class="uptime-value" id="uptime-val">--</span>
                    <button class="restart-btn" onclick="restartServer()" title="Restart server process">restart</button>
                </div>
                <div class="theme-toggle">
                    <button class="theme-btn" onclick="setTheme('light')" id="theme-light">light</button>
                    <button class="theme-btn" onclick="setTheme('dark')" id="theme-dark">dark</button>
                    <button class="theme-btn" onclick="setTheme('auto')" id="theme-auto">auto</button>
                </div>
            </div>
        </div>

        <div class="main">

            <!-- ASR panel -->
            <div class="main-content asr-panel" id="asr-panel">
                <div class="header">
                    <h2>Transcripts</h2>
                    <div class="header-controls">
                        <div class="sort-controls">
                            <span class="sort-label">sort:</span>
                            <button class="sort-btn active" id="sort-time" onclick="setSort('time')">
                                time
                                <svg id="sort-time-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
                            </button>
                            <button class="sort-btn" id="sort-length" onclick="setSort('length')">
                                length
                                <svg id="sort-length-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
                            </button>
                            <button class="sort-btn" id="sort-latency" onclick="setSort('latency')">
                                latency
                                <svg id="sort-latency-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
                            </button>
                        </div>
                        <div class="speed-controls">
                            <span class="speed-label">speed:</span>
                            <button class="speed-btn" data-speed="1" onclick="setSpeed(1)">1x</button>
                            <button class="speed-btn active" data-speed="2" onclick="setSpeed(2)">2x</button>
                            <button class="speed-btn" data-speed="4" onclick="setSpeed(4)">4x</button>
                        </div>
                    </div>
                </div>
                <div id="transcripts"><div class="empty">select a date to view transcripts</div></div>
            </div>

            <!-- TTS panel (history only) -->
            <div class="main-content tts-panel" id="tts-panel">
                <div class="header">
                    <h2>TTS History</h2>
                    <div class="header-controls">
                        <div class="sort-controls">
                            <span class="sort-label">sort:</span>
                            <button class="sort-btn active" onclick="setHistorySort('tts','time',this)">time <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                            <button class="sort-btn" onclick="setHistorySort('tts','latency',this)">latency <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                        </div>
                    </div>
                </div>
                <div id="tts-history"><div class="empty">no TTS history yet</div></div>
            </div>

            <!-- Translate panel (history only) -->
            <div class="main-content translate-panel" id="translate-panel">
                <div class="header">
                    <h2>Translation History</h2>
                    <div class="header-controls">
                        <div class="sort-controls">
                            <span class="sort-label">sort:</span>
                            <button class="sort-btn active" onclick="setHistorySort('translate','time',this)">time <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                            <button class="sort-btn" onclick="setHistorySort('translate','latency',this)">latency <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                        </div>
                    </div>
                </div>
                <div id="translate-history"><div class="empty">no translation history yet</div></div>
            </div>

            <!-- Image panel (history only) -->
            <div class="main-content image-panel" id="image-panel">
                <div class="header">
                    <h2>Generation History</h2>
                    <div class="header-controls">
                        <div class="sort-controls">
                            <span class="sort-label">sort:</span>
                            <button class="sort-btn active" onclick="setHistorySort('image','time',this)">time <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                            <button class="sort-btn" onclick="setHistorySort('image','latency',this)">latency <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                            <button class="sort-btn" onclick="setHistorySort('image','length',this)">length <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                        </div>
                    </div>
                </div>
                <div id="image-history"><div class="empty">no history yet</div></div>
            </div>

            <!-- Vision panel (history only) -->
            <div class="main-content vision-panel" id="vision-panel">
                <div class="header">
                    <h2>Vision History</h2>
                    <div class="header-controls">
                        <div class="sort-controls">
                            <span class="sort-label">sort:</span>
                            <button class="sort-btn active" onclick="setHistorySort('vision','time',this)">time <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                            <button class="sort-btn" onclick="setHistorySort('vision','latency',this)">latency <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                            <button class="sort-btn" onclick="setHistorySort('vision','length',this)">length <svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
                        </div>
                    </div>
                </div>
                <div id="vision-history"><div class="empty">no vision history yet</div></div>
            </div>

            <!-- Log panel -->
            <div class="main-content log-panel" id="log-panel">
                <div class="header">
                    <h2>Server Log</h2>
                    <span class="log-status" id="log-stream-status">~/.openclaw/workspace/logs/mls.log</span>
                </div>
                <div class="log-body" id="log-body"></div>
            </div>
        </div>

        <!-- Compose open strip (shown when compose panel is collapsed) -->
        <div class="compose-open-strip" id="compose-open-strip" onclick="toggleComposePanel()" style="display:none;" title="Open compose panel">
            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="7" y1="2" x2="3" y2="5"/><line x1="3" y1="5" x2="7" y2="8"/></svg>
        </div>

        <!-- Resize handle -->
        <div class="resize-handle" id="resize-handle"></div>

        <!-- Compose panel (right column) -->
        <div class="compose-panel" id="compose-panel">
            <div class="compose-panel-header">
                <span class="compose-panel-title" id="compose-panel-title"></span>
                <button class="icon-btn" onclick="toggleComposePanel()" title="close">
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="2" y1="2" x2="8" y2="8"/><line x1="8" y1="2" x2="2" y2="8"/></svg>
                </button>
            </div>
            <div class="compose-panel-body">
                <!-- TTS compose -->
                <div class="compose-content" id="compose-tts">
                    <div class="tts-compose">
                        <textarea class="tts-textarea" id="tts-text" placeholder="Enter text to synthesize..."></textarea>
                        <div class="tts-controls">
                            <select class="tts-select" id="tts-voice-select">
                                <option value="Chelsie">Chelsie (EN/F)</option>
                                <option value="Ethan">Ethan (EN/M)</option>
                                <option value="Vivian">Vivian (ZH/F)</option>
                            </select>
                            <select class="tts-select" id="tts-lang-select">
                                <option value="en">English</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="es">Spanish</option>
                                <option value="ru">Russian</option>
                                <option value="it">Italian</option>
                                <option value="pt">Portuguese</option>
                            </select>
                            <label style="font-size:11px;color:var(--text-3);">speed:</label>
                            <input type="number" class="tts-speed-input" id="tts-speed" value="1.0" min="0.5" max="2.0" step="0.1">
                            <input type="text" class="tts-speed-input" id="tts-instruct" placeholder="Voice instruct (optional)" style="width:100%;font-size:11px;">
                            <button class="synthesize-btn" id="synthesize-btn" onclick="synthesize()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/><path d="M19.07 4.93a10 10 0 010 14.14"/></svg>
                                <span id="synthesize-btn-text">Synthesize</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Translate compose -->
                <div class="compose-content" id="compose-translate">
                    <div class="translate-compose">
                        <div class="translate-controls">
                            <select class="translate-select" id="translate-source-lang"></select>
                            <button class="swap-btn" onclick="swapLanguages()" title="Swap languages">&#8644;</button>
                            <select class="translate-select" id="translate-target-lang"></select>
                            <button class="synthesize-btn" id="translate-btn" onclick="doTranslate()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                                <span id="translate-btn-text">Translate</span>
                            </button>
                        </div>
                        <textarea class="translate-textarea" id="translate-input" placeholder="Enter text to translate..."></textarea>
                        <div class="translate-output-label">Translation</div>
                        <textarea class="translate-textarea" id="translate-output" placeholder="Translation will appear here..." readonly></textarea>
                    </div>
                    <div class="file-translate-section">
                        <div class="translate-compose-header">File Translation</div>
                        <div class="file-translate-controls">
                            <input type="text" class="file-input" id="translate-file-path" placeholder="File path (e.g. ~/Documents/input.txt)">
                            <select class="translate-select" id="translate-file-source"></select>
                            <select class="translate-select" id="translate-file-target"></select>
                            <button class="synthesize-btn" id="translate-file-btn" onclick="startFileTranslate()">
                                <span id="translate-file-btn-text">Start</span>
                            </button>
                        </div>
                        <div class="file-progress" id="translate-file-progress" style="display:none;">
                            <span id="translate-file-progress-text">0 / 0 lines</span>
                            <div class="file-progress-bar">
                                <div class="file-progress-fill" id="translate-file-progress-fill" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image compose -->
                <div class="compose-content" id="compose-image">
                    <div class="image-compose">
                        <textarea class="tts-textarea" id="image-prompt" placeholder="Enter prompt description..."></textarea>
                        <div class="tts-controls">
                            <select class="translate-select" id="image-resolution">
                                <option value="1024x1024" selected>1024x1024</option>
                                <option value="768x1024">768x1024</option>
                                <option value="1024x768">1024x768</option>
                                <option value="512x512">512x512</option>
                            </select>
                            <button class="synthesize-btn" id="image-gen-btn" onclick="generateImage()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                                <span id="image-gen-btn-text">Generate</span>
                            </button>
                        </div>
                        <div class="image-result" id="image-result" style="display:none"></div>
                    </div>
                </div>

                <!-- Vision compose -->
                <div class="compose-content" id="compose-vision">
                    <div class="vision-compose">
                        <div class="vision-upload-area">
                            <div class="vision-preview" id="vision-preview">
                                <span>Drop or select image</span>
                            </div>
                            <div class="vision-inputs">
                                <input type="file" id="vision-file-input" accept="image/*" style="font-size:12px;font-family:'JetBrains Mono',monospace;" onchange="onVisionFileSelect(this)">
                                <textarea class="tts-textarea" id="vision-prompt" placeholder="Enter prompt (e.g. What is in this image?)" style="min-height:60px;">What is in this image? Describe everything you can see.</textarea>
                                <div class="tts-controls">
                                    <label style="font-size:11px;color:var(--text-3);">max tokens:</label>
                                    <input type="number" class="tts-speed-input" id="vision-max-tokens" value="512" min="64" max="2048" step="64">
                                    <button class="synthesize-btn" id="vision-analyze-btn" onclick="analyzeVision()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
                                        <span id="vision-analyze-btn-text">Analyze</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="vision-result" style="display:none;margin-top:16px;padding-top:16px;border-top:1px dashed var(--border);">
                            <div style="font-size:11px;color:var(--text-3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">Response</div>
                            <div id="vision-result-text" style="font-size:14px;line-height:1.6;white-space:pre-wrap;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ========== Shared state ==========
        let currentTab = 'asr';
        let currentAudio = null;
        let _serverStartEpoch = 0;
        const historySortState = {
            tts: { field: 'time', ascending: false },
            translate: { field: 'time', ascending: false },
            image: { field: 'time', ascending: false },
            vision: { field: 'time', ascending: false }
        };
        let _lastHistoryData = { tts: [], translate: [], image: [], vision: [] };
        let _prevHistoryCounts = { asr: -1, tts: -1, translate: -1, image: -1, vision: -1 };
        const _failedImages = new Set();

        function flashServiceRow(service) {
            const row = document.getElementById('svc-row-' + service);
            if (!row) return;
            row.classList.remove('new-item');
            void row.offsetWidth; // force reflow to restart animation
            row.classList.add('new-item');
            setTimeout(() => row.classList.remove('new-item'), 3000);
        }

        function sortHistoryRecords(records, field, ascending) {
            const sorted = [...records].sort((a, b) => {
                if (field === 'latency') return (b.latency_ms || 0) - (a.latency_ms || 0);
                if (field === 'length') return (b.prompt || '').length - (a.prompt || '').length;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            return ascending ? sorted.reverse() : sorted;
        }

        function _applySortedRender(service) {
            const st = historySortState[service];
            const data = _lastHistoryData[service];
            if (!data || !data.length) return;
            const sorted = sortHistoryRecords(data, st.field, st.ascending);
            if (service === 'tts') renderTTSHistory(sorted);
            else if (service === 'translate') renderTranslateHistory(sorted);
            else if (service === 'image') renderImageHistory(sorted);
            else if (service === 'vision') renderVisionHistory(sorted);
        }

        function setHistorySort(service, sortBy, btn) {
            const st = historySortState[service];
            if (st.field === sortBy) {
                st.ascending = !st.ascending;
            } else {
                st.field = sortBy;
                st.ascending = false;
            }
            // Update button active state within the same panel
            const panel = btn.closest('.header');
            panel.querySelectorAll('.sort-btn').forEach(b => {
                b.classList.remove('active');
                const icon = b.querySelector('.sort-icon');
                if (icon) icon.style.transform = 'rotate(0deg)';
            });
            btn.classList.add('active');
            const icon = btn.querySelector('.sort-icon');
            if (icon) icon.style.transform = st.ascending ? 'rotate(180deg)' : 'rotate(0deg)';
            _applySortedRender(service);
        }

        // ========== ASR state ==========
        let currentDate = null;
        let lastRecordCount = 0;
        let knownDates = [];
        let currentSort = 'time';
        let sortAscending = false;
        let currentSpeed = 2;

        // ========== TTS state ==========
        let ttsCurrentDate = null;
        let ttsHistory = [];
        let ttsPaused = false;

        // ========== Translate state ==========
        let translatePaused = false;
        let translateCurrentDate = null;
        let translateLanguages = [];
        let translateFilePolling = null;
        
        // ========== Image state ==========
        let imageCurrentDate = null;

        // ========== Vision state ==========
        let visionCurrentDate = null;
        let visionPaused = false;
        let visionUploadedPath = null;

        // ========== Tab switching ==========
        // ========== Mini Calendar ==========
        let calYear, calMonth; // 0-indexed month
        let calAvailableDates = {}; // {service: Set of 'YYYY-MM-DD'}
        
        function initCalendar() {
            const now = new Date();
            calYear = now.getFullYear();
            calMonth = now.getMonth();
            renderCalendar();
        }
        
        function calPrevMonth() {
            calMonth--;
            if (calMonth < 0) { calMonth = 11; calYear--; }
            renderCalendar();
        }
        
        function calNextMonth() {
            calMonth++;
            if (calMonth > 11) { calMonth = 0; calYear++; }
            renderCalendar();
        }
        
        function renderCalendar() {
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            document.getElementById('cal-month-label').textContent = months[calMonth] + ' ' + calYear;
            
            const grid = document.getElementById('cal-grid');
            const headers = ['Mo','Tu','We','Th','Fr','Sa','Su'];
            let html = headers.map(h => '<div class="cal-header">' + h + '</div>').join('');
            
            const firstDay = new Date(calYear, calMonth, 1);
            let startDay = firstDay.getDay() - 1; // Monday = 0
            if (startDay < 0) startDay = 6;
            const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
            const today = new Date().toISOString().slice(0, 10);
            const dates = calAvailableDates[currentTab] || new Set();
            
            for (let i = 0; i < startDay; i++) html += '<div class="cal-day"></div>';
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = calYear + '-' + String(calMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                const hasData = dates.has(dateStr);
                const isActive = (currentTab === 'asr' && dateStr === currentDate) ||
                                 (currentTab === 'tts' && dateStr === ttsCurrentDate) ||
                                 (currentTab === 'translate' && dateStr === translateCurrentDate) ||
                                 (currentTab === 'image' && dateStr === imageCurrentDate) ||
                                 (currentTab === 'vision' && dateStr === visionCurrentDate);
                const isToday = dateStr === today;
                let cls = 'cal-day';
                if (hasData) cls += ' has-data';
                if (isActive) cls += ' active';
                if (isToday) cls += ' today';
                const onclick = hasData ? ' onclick="calSelectDate(\'' + dateStr + '\')"' : '';
                html += '<div class="' + cls + '"' + onclick + '>' + d + '</div>';
            }
            grid.innerHTML = html;
        }
        
        function calSelectDate(dateStr) {
            if (currentTab === 'asr') {
                currentDate = dateStr;
                loadTranscripts(dateStr);
            } else if (currentTab === 'tts') {
                ttsCurrentDate = dateStr;
                loadTTSHistoryForDate(dateStr);
            } else if (currentTab === 'translate') {
                translateCurrentDate = dateStr;
                loadTranslateHistoryForDate(dateStr);
            } else if (currentTab === 'image') {
                imageCurrentDate = dateStr;
                loadImageHistoryForDate(dateStr);
            } else if (currentTab === 'vision') {
                visionCurrentDate = dateStr;
                loadVisionHistoryForDate(dateStr);
            }
            renderCalendar();
        }
        
        async function loadCalendarDates(service) {
            try {
                if (service === 'asr') {
                    const res = await fetch('/api/dates');
                    const dates = await res.json();
                    calAvailableDates.asr = new Set(dates);
                } else if (service === 'tts') {
                    const res = await fetch('/api/tts/history');
                    const data = await res.json();
                    calAvailableDates.tts = new Set(data.map(r => r.date));
                } else if (service === 'translate') {
                    const res = await fetch('/api/translate/history');
                    const data = await res.json();
                    calAvailableDates.translate = new Set(data.map(r => r.date));
                } else if (service === 'image') {
                    const res = await fetch('/api/image/history');
                    const data = await res.json();
                    calAvailableDates.image = new Set(data.map(r => r.date));
                } else if (service === 'vision') {
                    const res = await fetch('/api/vision/history');
                    const data = await res.json();
                    calAvailableDates.vision = new Set(data.map(r => r.date));
                }
            } catch(e) {
                calAvailableDates[service] = new Set();
            }
            renderCalendar();
        }

        let composePanelOpen = true;
        const composeTitles = { tts: 'Synthesize', translate: 'Translate', image: 'Generate', vision: 'Analyze' };

        function switchTab(tab) {
            currentTab = tab;

            // Update service row active state
            ['asr', 'tts', 'translate', 'image', 'vision'].forEach(t => {
                const row = document.getElementById('svc-row-' + t);
                if (row) row.classList.toggle('active', t === tab);
            });
            // Highlight log chart when log tab is active
            document.querySelector('.log-chart-wrap').classList.toggle('active', tab === 'log');

            // Update main panels
            document.getElementById('asr-panel').style.display = tab === 'asr' ? 'block' : 'none';
            document.getElementById('tts-panel').style.display = tab === 'tts' ? 'block' : 'none';
            document.getElementById('translate-panel').style.display = tab === 'translate' ? 'block' : 'none';
            document.getElementById('image-panel').style.display = tab === 'image' ? 'block' : 'none';
            document.getElementById('vision-panel').style.display = tab === 'vision' ? 'block' : 'none';
            document.getElementById('log-panel').style.display = tab === 'log' ? 'flex' : 'none';

            // Log streaming: connect when active, disconnect when leaving
            if (tab === 'log') {
                connectLogStream();
            } else {
                disconnectLogStream();
            }

            // Update compose panel
            const hasCompose = ['tts', 'translate', 'image', 'vision'].includes(tab);
            const panel = document.getElementById('compose-panel');
            const handle = document.getElementById('resize-handle');
            const openBtn = document.getElementById('compose-open-strip');
            if (hasCompose) {
                if (composePanelOpen) {
                    panel.classList.remove('collapsed');
                    handle.style.display = '';
                    openBtn.style.display = 'none';
                } else {
                    panel.classList.add('collapsed');
                    handle.style.display = 'none';
                    openBtn.style.display = '';
                }
                document.getElementById('compose-panel-title').textContent = composeTitles[tab] || '';
                ['tts', 'translate', 'image', 'vision'].forEach(t => {
                    const el = document.getElementById('compose-' + t);
                    if (el) el.classList.toggle('active', t === tab);
                });
            } else {
                panel.classList.add('collapsed');
                handle.style.display = 'none';
                openBtn.style.display = 'none';
            }

            // Refresh calendar for this service
            if (tab !== 'log') loadCalendarDates(tab);

            if (tab === 'tts') {
                loadTTSHistory();
                loadTTSStatus();
                updateTTSStats();
            }
            if (tab === 'translate') {
                loadTranslateLanguages();
                loadTranslateStatus();
                loadTranslateHistory();
                updateTranslateStats();
            }
            if (tab === 'image') {
                loadImageStatus();
                loadImageHistory();
                updateImageStats();
            }
            if (tab === 'vision') {
                loadVisionStatus();
                loadVisionHistory();
                updateVisionStats();
            }
        }

        function toggleComposePanel() {
            composePanelOpen = !composePanelOpen;
            switchTab(currentTab);
        }

        // Resize handle drag
        (function initResize() {
            const handle = document.getElementById('resize-handle');
            const panel = document.getElementById('compose-panel');
            let dragging = false;
            handle.addEventListener('mousedown', (e) => {
                dragging = true;
                handle.classList.add('active');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            document.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                const containerRight = document.querySelector('.container').getBoundingClientRect().right;
                const newWidth = Math.max(250, Math.min(600, containerRight - e.clientX));
                panel.style.width = newWidth + 'px';
            });
            document.addEventListener('mouseup', () => {
                if (!dragging) return;
                dragging = false;
                handle.classList.remove('active');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });
            handle.addEventListener('dblclick', () => {
                panel.style.width = '350px';
            });
        })();

        function onServiceRowClick(event, tab) {
            // Collapse all other rows, expand the clicked one
            document.querySelectorAll('.service-row').forEach(r => {
                if (r.id === 'svc-row-' + tab) {
                    r.classList.add('active', 'expanded');
                } else {
                    r.classList.remove('active', 'expanded');
                }
            });
            // Switch main content
            switchTab(tab);
        }

        // ========== ASR functions ==========

        function setSpeed(speed) {
            currentSpeed = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.speed) === speed);
            });
            if (currentAudio) {
                currentAudio.playbackRate = speed;
            }
        }

        async function loadDates() {
            const res = await fetch('/api/dates');
            const dates = await res.json();

            const hadNewDate = dates.length > knownDates.length;
            knownDates = dates;
            
            // Update calendar
            calAvailableDates.asr = new Set(dates);
            renderCalendar();

            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

            try {
                const todayRes = await fetch(`/api/transcripts/${today}`);
                if (todayRes.ok) {
                    const todayRecords = await todayRes.json();
                    document.getElementById('stat-today').textContent = todayRecords.length + ' items';
                    const todayDuration = todayRecords.reduce((sum, r) => sum + (r.audio_duration_ms || 0), 0);
                    document.getElementById('stat-today-duration').textContent = formatDurationHHMM(todayDuration);
                } else {
                    document.getElementById('stat-today').textContent = '0 items';
                    document.getElementById('stat-today-duration').textContent = '00:00';
                }
            } catch (e) {
                document.getElementById('stat-today').textContent = '0 items';
                document.getElementById('stat-today-duration').textContent = '00:00';
            }

            let totalDuration = 0;
            for (const date of dates) {
                try {
                    const res = await fetch(`/api/transcripts/${date}`);
                    if (res.ok) {
                        const records = await res.json();
                        totalDuration += records.reduce((sum, r) => sum + (r.audio_duration_ms || 0), 0);
                    }
                } catch (e) {}
            }
            document.getElementById('stat-total-duration').textContent = formatDurationHHMM(totalDuration);

            if (dates.includes(today)) {
                loadTranscripts(today);
            } else if (!currentDate || hadNewDate) {
                loadTranscripts(dates[0]);
            }

            document.getElementById('stat-total').textContent = dates.length + ' days';
        }

        async function loadTranscripts(date) {
            currentDate = date;
            document.querySelectorAll('#dates .date-item').forEach(el => {
                el.classList.toggle('active', el.dataset.date === date);
            });
            const res = await fetch(`/api/transcripts/${date}`);
            const records = await res.json();
            const container = document.getElementById('transcripts');

            const hadNewRecords = records.length > lastRecordCount;
            lastRecordCount = records.length;
            if (hadNewRecords && _prevHistoryCounts.asr >= 0) flashServiceRow('asr');
            _prevHistoryCounts.asr = records.length;

            const now = new Date(); const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            if (date === today) {
                document.getElementById('stat-today').textContent = records.length + ' items';
            }

            if (records.length === 0) {
                container.innerHTML = '<div class="empty">no transcripts for this date</div>';
                return;
            }

            const sortedRecords = sortRecords(records);

            container.innerHTML = sortedRecords.map((r, i) => {
                const time = new Date(r.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                const latency = (r.latency_ms || r.duration_ms || 0) / 1000;
                const audioLen = (r.audio_duration_ms || 0) / 1000;
                const model = r.model || 'unknown';
                return `
                    <div class="transcript" data-audio-url="/audio/${date}/${r.audio_file}">
                        <div class="transcript-header">
                            <span class="transcript-time">${time}</span>
                            <span class="transcript-latency">
                                ${CLOCK_ICON}
                                ${latency.toFixed(1)}s
                            </span>
                            <span class="transcript-model">${model}</span>
                        </div>
                        <div class="transcript-text">${escapeHtml(r.text)}</div>
                        <div class="waveform-container" onclick="seekAudio(event, this)">
                            <canvas></canvas>
                            <div class="waveform-progress"></div>
                            <div class="waveform-time">0:00 / ${audioLen.toFixed(1)}s</div>
                            <div class="waveform-loading">loading waveform...</div>
                        </div>
                        <div class="transcript-footer">
                            <button class="play-btn" onclick="toggleAudio(this)">
                                <svg class="icon-play" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5,3 19,12 5,21"/></svg>
                                <svg class="icon-pause" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>
                                <span class="btn-text">play</span>
                            </button>
                            <a href="/audio/${date}/${r.audio_file}" download class="play-btn" style="text-decoration:none;text-align:center;">download</a>
                        </div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.transcript').forEach(el => loadWaveform(el));

            if (hadNewRecords) {
                container.scrollTop = container.scrollHeight;
            }
        }

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const waveformCache = new Map();
        const WAVEFORM_CACHE_MAX = 200;

        function waveformCacheSet(url, data) {
            if (waveformCache.size >= WAVEFORM_CACHE_MAX) {
                const oldest = waveformCache.keys().next().value;
                waveformCache.delete(oldest);
            }
            waveformCache.set(url, data);
        }

        // Concurrency-limited waveform loader
        let _wfActive = 0;
        const _wfMaxConcurrent = 3;
        const _wfQueue = [];

        function _wfNext() {
            while (_wfActive < _wfMaxConcurrent && _wfQueue.length > 0) {
                const fn = _wfQueue.shift();
                _wfActive++;
                fn().finally(() => { _wfActive--; _wfNext(); });
            }
        }

        function _wfEnqueue(fn) {
            _wfQueue.push(fn);
            _wfNext();
        }

        // IntersectionObserver: only load waveforms when visible
        const _wfObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    _wfObserver.unobserve(entry.target);
                    _wfEnqueue(() => _loadWaveformCore(entry.target));
                }
            });
        }, { rootMargin: '200px' });

        function loadWaveform(transcriptEl) {
            const url = transcriptEl.dataset.audioUrl;
            if (!url) return;
            const container = transcriptEl.querySelector('.waveform-container');
            if (!container) return;
            // Already loaded or observed - skip
            if (container.dataset.wfState) return;
            const cached = waveformCache.get(url);
            if (cached === false) {
                container.dataset.wfState = 'done';
                const loading = container.querySelector('.waveform-loading');
                if (loading) loading.textContent = 'audio not available';
                return;
            }
            if (cached) {
                // Cache hit - draw immediately, no observer needed
                container.dataset.wfState = 'done';
                const canvas = container.querySelector('canvas');
                const loading = container.querySelector('.waveform-loading');
                const timeDisplay = container.querySelector('.waveform-time');
                if (cached.duration > 0 && timeDisplay) {
                    timeDisplay.textContent = '0:00 / ' + cached.duration.toFixed(1) + 's';
                }
                drawWaveform(canvas, cached, 0);
                if (loading) loading.style.display = 'none';
                return;
            }
            // Mark as pending and observe for visibility
            container.dataset.wfState = 'pending';
            _wfObserver.observe(transcriptEl);
        }

        async function _loadWaveformCore(transcriptEl) {
            const url = transcriptEl.dataset.audioUrl;
            const container = transcriptEl.querySelector('.waveform-container');
            if (!container) return;
            const canvas = container.querySelector('canvas');
            const loading = container.querySelector('.waveform-loading');
            const timeDisplay = container.querySelector('.waveform-time');

            try {
                let waveformData = waveformCache.get(url);
                if (waveformData === false) {
                    if (loading) loading.textContent = 'audio not available';
                    container.dataset.wfState = 'done';
                    return;
                }
                if (!waveformData) {
                    const response = await fetch(url);
                    if (!response.ok) {
                        waveformCacheSet(url, false);
                        if (loading) loading.textContent = 'audio not available';
                        container.dataset.wfState = 'done';
                        return;
                    }
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    waveformData = extractWaveform(audioBuffer, 100);
                    waveformData.duration = audioBuffer.duration;
                    waveformCacheSet(url, waveformData);
                }
                const duration = waveformData.duration || 0;
                if (duration > 0 && timeDisplay) {
                    timeDisplay.textContent = '0:00 / ' + duration.toFixed(1) + 's';
                }
                drawWaveform(canvas, waveformData, 0);
                if (loading) loading.style.display = 'none';
                container.dataset.wfState = 'done';
            } catch (e) {
                waveformCacheSet(url, false);
                if (loading) loading.textContent = 'audio not available';
                container.dataset.wfState = 'done';
            }
        }

        function extractWaveform(audioBuffer, samples) {
            const channelData = audioBuffer.getChannelData(0);
            const blockSize = Math.floor(channelData.length / samples);
            const waveform = [];
            for (let i = 0; i < samples; i++) {
                let sum = 0;
                for (let j = 0; j < blockSize; j++) {
                    sum += Math.abs(channelData[i * blockSize + j]);
                }
                waveform.push(sum / blockSize);
            }
            const max = Math.max(...waveform);
            return waveform.map(v => v / max);
        }

        function drawWaveform(canvas, data, progress) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            const needW = Math.round(rect.width * dpr);
            const needH = Math.round(rect.height * dpr);
            // Only reallocate canvas buffer when dimensions actually change
            if (canvas.width !== needW || canvas.height !== needH) {
                canvas.width = needW;
                canvas.height = needH;
                ctx.scale(dpr, dpr);
            }

            const width = rect.width;
            const height = rect.height;
            const barWidth = width / data.length;
            const gap = 1;

            ctx.clearRect(0, 0, width, height);

            data.forEach((val, i) => {
                const x = i * barWidth;
                const barHeight = val * height * 0.8;
                const y = (height - barHeight) / 2;
                
                if (i / data.length < progress) {
                    ctx.fillStyle = '#e25f4a';
                } else {
                    ctx.fillStyle = '#d0d5dd';
                }
                
                ctx.fillRect(x, y, barWidth - gap, barHeight);
            });
        }

        function toggleAudio(btn) {
            const transcriptEl = btn.closest('.transcript') || btn.closest('.tts-item');
            const url = transcriptEl.dataset.audioUrl;
            const container = transcriptEl.querySelector('.waveform-container');
            const canvas = container.querySelector('canvas');
            const progressEl = container.querySelector('.waveform-progress');
            
            // If clicking the currently playing audio
            if (currentAudio && currentAudio.src.endsWith(url)) {
                if (currentAudio.paused) {
                    currentAudio.play();
                    btn.querySelector('.icon-play').style.display = 'none';
                    btn.querySelector('.icon-pause').style.display = 'block';
                    btn.querySelector('.btn-text').textContent = 'pause';
                } else {
                    currentAudio.pause();
                    btn.querySelector('.icon-play').style.display = 'block';
                    btn.querySelector('.icon-pause').style.display = 'none';
                    btn.querySelector('.btn-text').textContent = 'play';
                }
                return;
            }

            // Stop previous audio and release resources
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.removeAttribute('src');
                currentAudio.load(); // release network/memory resources
                currentAudio = null;
                document.querySelectorAll('button.play-btn').forEach(b => {
                    if (b.querySelector('.icon-play')) b.querySelector('.icon-play').style.display = 'block';
                    if (b.querySelector('.icon-pause')) b.querySelector('.icon-pause').style.display = 'none';
                    if (b.querySelector('.btn-text')) b.querySelector('.btn-text').textContent = 'play';
                });
                // Reset waveforms
                document.querySelectorAll('.waveform-container canvas').forEach(c => {
                   const tEl = c.closest('.transcript') || c.closest('.tts-item');
                   const u = tEl ? tEl.dataset.audioUrl : null;
                   const wd = waveformCache.get(u);
                   if (wd) drawWaveform(c, wd, 0);
                });
            }

            currentAudio = new Audio(url);
            currentAudio.playbackRate = currentSpeed;
            
            currentAudio.addEventListener('timeupdate', () => {
                const progress = currentAudio.currentTime / currentAudio.duration;
                // Update progress bar width is actually handled by redrawing canvas now
                const wd = waveformCache.get(url);
                if (wd) drawWaveform(canvas, wd, progress);
                
                const cur = formatTime(currentAudio.currentTime);
                const tot = formatTime(currentAudio.duration);
                container.querySelector('.waveform-time').textContent = `${cur} / ${tot}`;
            });

            currentAudio.addEventListener('ended', () => {
                btn.querySelector('.icon-play').style.display = 'block';
                btn.querySelector('.icon-pause').style.display = 'none';
                btn.querySelector('.btn-text').textContent = 'play';
                const wd = waveformCache.get(url);
                if (wd) drawWaveform(canvas, wd, 0);
                container.querySelector('.waveform-time').textContent = `0:00 / ${formatTime(currentAudio.duration)}`;
                currentAudio = null;
            });

            currentAudio.play();
            btn.querySelector('.icon-play').style.display = 'none';
            btn.querySelector('.icon-pause').style.display = 'block';
            btn.querySelector('.btn-text').textContent = 'pause';
        }

        function seekAudio(e, container) {
            const itemEl = container.closest('.transcript') || container.closest('.tts-item');
            if (!currentAudio) {
                // If not playing, start playing
                const btn = itemEl.querySelector('.play-btn');
                toggleAudio(btn);
            }
            
            // Check if this container matches current audio
            const url = itemEl.dataset.audioUrl;
            if (!currentAudio.src.endsWith(url)) {
                 const btn = itemEl.querySelector('.play-btn');
                 toggleAudio(btn);
            }

            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const progress = x / rect.width;
            if (currentAudio && currentAudio.duration) {
                currentAudio.currentTime = progress * currentAudio.duration;
            }
        }

        // ========== Helper functions ==========
        function formatDurationHHMM(ms) {
            const sec = Math.floor(ms / 1000);
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            if (h > 0) {
                return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            }
            return `${m}:${String(s).padStart(2,'0')}`;
        }

        function formatTime(s) {
            if (!s) return '0:00';
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${String(sec).padStart(2, '0')}`;
        }

        const CLOCK_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>';

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function sortRecords(records) {
            return records.sort((a, b) => {
                let valA, valB;
                if (currentSort === 'time') {
                    valA = new Date(a.timestamp);
                    valB = new Date(b.timestamp);
                } else if (currentSort === 'length') {
                    valA = a.audio_duration_ms || 0;
                    valB = b.audio_duration_ms || 0;
                } else if (currentSort === 'latency') {
                    valA = a.latency_ms || 0;
                    valB = b.latency_ms || 0;
                }

                if (sortAscending) {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });
        }

        function setSort(type) {
            if (currentSort === type) {
                sortAscending = !sortAscending;
            } else {
                currentSort = type;
                sortAscending = false;
            }

            // Update UI
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('sort-' + type).classList.add('active');
            
            const icon = document.getElementById('sort-' + type + '-icon');
            icon.style.transform = sortAscending ? 'rotate(180deg)' : 'rotate(0deg)';

            if (currentDate) loadTranscripts(currentDate);
        }

        function togglePause() {
            // Placeholder - actual API call needed
            // For now just toggle UI
            const dot = document.getElementById('status-dot');
            dot.classList.toggle('paused');
        }

        function restartModel() {
            fetch('/api/server/restart', {method: 'POST'})
                .then(res => res.json())
                .then(data => alert('Model restarted: ' + data.model));
        }

        async function switchModel(model) {
            const res = await fetch('/api/model/switch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model})
            });
            const data = await res.json();
            document.getElementById('svc-model-short-asr').textContent = data.model.split('/').pop();
        }

        // ========== TTS functions ==========
        
        async function loadTTSStatus() {
            const res = await fetch('/api/tts/status');
            const status = await res.json();

            document.getElementById('svc-model-short-tts').textContent = status.model_short;
            document.getElementById('tts-model-name').textContent = status.model;

            const dot = document.getElementById('tts-status-dot');
            dot.className = 'status-dot';
            if (!status.loaded) dot.classList.add(status.loading ? 'loading' : 'error');
            else if (status.paused) dot.classList.add('paused');
            
            // Populate models
            const select = document.getElementById('tts-model-select');
            select.innerHTML = status.available_models.map(m => 
                `<option value="${m}" ${m === status.model ? 'selected' : ''}>${m.split('/').pop()}</option>`
            ).join('');

            // Populate voices
            const vRes = await fetch('/api/tts/voices');
            const voices = await vRes.json();
            const vSelect = document.getElementById('tts-voice-select');
            vSelect.innerHTML = voices.map(v => 
                `<option value="${v.id}">${v.name} (${v.language})</option>`
            ).join('');
        }

        async function loadTTSHistory() {
            const res = await fetch('/api/tts/history');
            const records = await res.json();
            if (records.length > _prevHistoryCounts.tts && _prevHistoryCounts.tts >= 0) flashServiceRow('tts');
            _prevHistoryCounts.tts = records.length;
            _lastHistoryData.tts = records;
            renderTTSHistory(sortHistoryRecords(records, historySortState.tts.field, historySortState.tts.ascending));
        }

        async function loadTTSHistoryForDate(date) {
            const res = await fetch(`/api/tts/history/${date}`);
            const records = await res.json();
            _lastHistoryData.tts = records;
            renderTTSHistory(sortHistoryRecords(records, historySortState.tts.field, historySortState.tts.ascending));
        }

        function renderTTSHistory(records) {
            const container = document.getElementById('tts-history');
            if (!records.length) {
                container.innerHTML = '<div class="empty">no TTS history</div>';
                return;
            }
            
            container.innerHTML = records.map(r => {
                const time = new Date(r.timestamp).toLocaleTimeString();
                const latency = (r.latency_ms / 1000).toFixed(1);
                
                return `
                <div class="tts-item" data-audio-url="/tts_audio/${r.audio_file}">
                    <div class="transcript-header">
                        <span class="transcript-time">${time}</span>
                        <span class="tts-voice-badge">${r.voice}</span>
                        <span class="tts-lang-badge">${r.language}</span>
                        <span class="transcript-latency">${CLOCK_ICON}${latency}s</span>
                    </div>
                    <div class="transcript-text">${escapeHtml(r.text)}</div>
                    <div class="waveform-container" onclick="seekAudio(event, this)">
                        <canvas></canvas>
                        <div class="waveform-progress"></div>
                        <div class="waveform-time">0:00 / ${(r.audio_duration_ms/1000).toFixed(1)}s</div>
                    </div>
                    <div class="transcript-footer">
                        <button class="play-btn" onclick="toggleAudio(this)">
                            <svg class="icon-play" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5,3 19,12 5,21"/></svg>
                            <svg class="icon-pause" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>
                            <span class="btn-text">play</span>
                        </button>
                        <a href="/tts_audio/${r.audio_file}" download class="play-btn" style="text-decoration:none;text-align:center;">download</a>
                    </div>
                </div>`;
            }).join('');
            
            document.querySelectorAll('.tts-item').forEach(el => loadWaveform(el));
        }

        async function synthesize() {
            const text = document.getElementById('tts-text').value;
            const voice = document.getElementById('tts-voice-select').value;
            const lang = document.getElementById('tts-lang-select').value;
            const speed = parseFloat(document.getElementById('tts-speed').value);
            const instruct = document.getElementById('tts-instruct').value.trim() || null;
            
            const btn = document.getElementById('synthesize-btn');
            const btnText = document.getElementById('synthesize-btn-text');
            btn.disabled = true;
            btnText.textContent = 'Generating...';
            
            try {
                const payload = {text, voice, language: lang, speed};
                if (instruct) payload.instruct = instruct;
                const res = await fetch('/synthesize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                const data = await res.json();
                loadTTSHistory(); // Refresh list
                
            } catch(e) {
                alert('TTS failed: ' + e.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Synthesize';
            }
        }
        
        async function switchTTSModel(model) {
            await fetch('/api/tts/model/switch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model})
            });
            loadTTSStatus();
        }
        
        function toggleTTSPause() {
            const action = ttsPaused ? 'resume' : 'pause';
            fetch(`/api/tts/server/${action}`, {method: 'POST'})
                .then(() => {
                    ttsPaused = !ttsPaused;
                    loadTTSStatus();
                });
        }
        
        // ========== Translate functions ==========
        
        async function loadTranslateStatus() {
            const res = await fetch('/api/translate/status');
            const status = await res.json();

            document.getElementById('svc-model-short-translate').textContent = 'TranslateGemma';
            document.getElementById('translate-model-name').textContent = status.model;

            const dot = document.getElementById('translate-status-dot');
            dot.className = 'status-dot';
            if (!status.loaded) dot.classList.add(status.loading ? 'loading' : 'error');
            else if (status.paused) dot.classList.add('paused');
        }

        async function loadTranslateLanguages() {
            if (translateLanguages.length > 0) return;
            const res = await fetch('/languages');
            const data = await res.json();
            translateLanguages = data.data.languages;
            
            const opts = translateLanguages.map(l => `<option value="${l.language}">${l.name}</option>`).join('');
            document.getElementById('translate-source-lang').innerHTML = opts;
            document.getElementById('translate-target-lang').innerHTML = opts;
            document.getElementById('translate-file-source').innerHTML = opts;
            document.getElementById('translate-file-target').innerHTML = opts;
            
            // Defaults
            document.getElementById('translate-source-lang').value = 'en';
            document.getElementById('translate-target-lang').value = 'zh';
            document.getElementById('translate-file-source').value = 'en';
            document.getElementById('translate-file-target').value = 'zh';
        }

        async function doTranslate() {
            const q = document.getElementById('translate-input').value;
            const source = document.getElementById('translate-source-lang').value;
            const target = document.getElementById('translate-target-lang').value;
            const btn = document.getElementById('translate-btn');
            const btnText = document.getElementById('translate-btn-text');
            
            if (!q.trim()) return;
            
            btn.disabled = true;
            btnText.textContent = 'Translating...';
            
            try {
                const res = await fetch('/translate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({q, source, target})
                });
                const data = await res.json();
                document.getElementById('translate-output').value = data.data.translations[0].translatedText;
                loadTranslateHistory();
            } catch(e) {
                alert('Translate failed: ' + e.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Translate';
            }
        }
        
        function swapLanguages() {
            const s = document.getElementById('translate-source-lang');
            const t = document.getElementById('translate-target-lang');
            const temp = s.value;
            s.value = t.value;
            t.value = temp;
        }

        async function loadTranslateHistory() {
            const res = await fetch('/api/translate/history');
            const records = await res.json();
            if (records.length > _prevHistoryCounts.translate && _prevHistoryCounts.translate >= 0) flashServiceRow('translate');
            _prevHistoryCounts.translate = records.length;
            _lastHistoryData.translate = records;
            renderTranslateHistory(sortHistoryRecords(records, historySortState.translate.field, historySortState.translate.ascending));
        }

        async function loadTranslateHistoryForDate(date) {
            const res = await fetch('/api/translate/history');
            let records = await res.json();
            records = records.filter(r => r.timestamp.startsWith(date));
            _lastHistoryData.translate = records;
            renderTranslateHistory(sortHistoryRecords(records, historySortState.translate.field, historySortState.translate.ascending));
        }

        function renderTranslateHistory(records) {
            const container = document.getElementById('translate-history');
            if (!records.length) {
                container.innerHTML = '<div class="empty">no translation history</div>';
                return;
            }
            
            container.innerHTML = records.map(r => {
                const time = new Date(r.timestamp).toLocaleTimeString();
                const latency = (r.latency_ms / 1000).toFixed(1);
                return `
                <div class="translate-item">
                    <div class="transcript-header">
                        <span class="transcript-time">${time}</span>
                        <span class="translate-lang-badge">${r.source_lang}</span>
                        <span class="translate-arrow"></span>
                        <span class="translate-lang-badge">${r.target_lang}</span>
                        <span class="transcript-latency">${CLOCK_ICON}${latency}s</span>
                    </div>
                    <div class="translate-source-text">${escapeHtml(r.source_text)}</div>
                    <div class="translate-result-text">${escapeHtml(r.translated_text)}</div>
                </div>`;
            }).join('');
        }
        
        async function startFileTranslate() {
            const file = document.getElementById('translate-file-path').value;
            const source = document.getElementById('translate-file-source').value;
            const target = document.getElementById('translate-file-target').value;
            
            if (!file) return;
            
            try {
                const res = await fetch('/translate/file', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({file, source, target})
                });
                const data = await res.json();
                if (data.status === 'started') {
                    pollFileTranslate(data.output);
                }
            } catch(e) {
                alert('File translate error: ' + e.message);
            }
        }
        
        function pollFileTranslate(output) {
            const progressEl = document.getElementById('translate-file-progress');
            progressEl.style.display = 'block';
            
            if (translateFilePolling) clearInterval(translateFilePolling);
            
            translateFilePolling = setInterval(async () => {
                const res = await fetch(`/translate/file/status?output=${encodeURIComponent(output)}`);
                const status = await res.json();
                
                const pct = status.lines ? (status.done / status.lines * 100) : 0;
                document.getElementById('translate-file-progress-fill').style.width = pct + '%';
                document.getElementById('translate-file-progress-text').textContent = 
                    `${status.done} / ${status.lines} lines (${status.status})`;
                
                if (status.status !== 'running') {
                    clearInterval(translateFilePolling);
                }
            }, 1000);
        }

        function toggleTranslatePause() {
            const action = translatePaused ? 'resume' : 'pause';
            fetch(`/api/translate/server/${action}`, {method: 'POST'})
                .then(() => {
                    translatePaused = !translatePaused;
                    loadTranslateStatus();
                });
        }
        
        // ========== Image functions ==========
        
        async function loadImageStatus() {
            const res = await fetch('/api/image/status');
            const status = await res.json();

            const dot = document.getElementById('image-status-dot');
            dot.className = 'status-dot';
            if (status.loaded) {
                // green
            } else if (status.loading) {
                dot.classList.add('loading');
            } else {
                dot.classList.add('error');
            }
        }
        
        async function generateImage() {
            const prompt = document.getElementById('image-prompt').value;
            const resolution = document.getElementById('image-resolution').value;
            
            if (!prompt.trim()) return;
            
            const btn = document.getElementById('image-gen-btn');
            const btnText = document.getElementById('image-gen-btn-text');
            const resultDiv = document.getElementById('image-result');
            
            btn.disabled = true;
            btnText.textContent = 'Generating...';
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            
            try {
                const res = await fetch('/api/image/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({prompt, resolution, steps: 4})
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                const data = await res.json();
                
                resultDiv.innerHTML = `<img src="${data.image_url}" alt="Generated Image">
                    <div style="font-size:11px;color:var(--text-3);margin-top:4px;">${data.resolution} | ${(data.latency_ms/1000).toFixed(1)}s | steps ${data.steps}${data.seed != null ? ' | seed '+data.seed : ''}</div>`;
                resultDiv.style.display = 'block';
                
                loadImageHistory();
                
            } catch(e) {
                alert('Image gen failed: ' + e.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Generate';
            }
        }
        
        async function loadImageHistory() {
            const res = await fetch('/api/image/history');
            const records = await res.json();
            if (records.length > _prevHistoryCounts.image && _prevHistoryCounts.image >= 0) flashServiceRow('image');
            _prevHistoryCounts.image = records.length;
            _lastHistoryData.image = records;
            renderImageHistory(sortHistoryRecords(records, historySortState.image.field, historySortState.image.ascending));
        }

        async function loadImageHistoryForDate(date) {
            const res = await fetch('/api/image/history');
            let records = await res.json();
            records = records.filter(r => r.timestamp.startsWith(date));
            _lastHistoryData.image = records;
            renderImageHistory(sortHistoryRecords(records, historySortState.image.field, historySortState.image.ascending));
        }
        
        function renderImageHistory(records) {
            const container = document.getElementById('image-history');
            if (!records.length) {
                container.innerHTML = '<div class="empty">no image history</div>';
                return;
            }
            
            container.innerHTML = records.map(r => {
                const time = new Date(r.timestamp).toLocaleTimeString();
                const latency = (r.latency_ms / 1000).toFixed(1);
                const imageUrl = `/image_output/${r.image_file}`;
                
                return `
                <div class="image-item">
                    <img src="${_failedImages.has(imageUrl) ? '' : imageUrl}" class="image-item-thumb${_failedImages.has(imageUrl) ? ' img-broken' : ''}" onclick="window.open('${imageUrl}', '_blank')" onerror="this.onerror=null;this.src='';this.classList.add('img-broken');_failedImages.add('${imageUrl}')">
                    <div class="image-item-details">
                        <div class="transcript-header">
                            <span class="transcript-time">${time}</span>
                            <span class="translate-lang-badge">${r.resolution}</span>
                            <span class="transcript-latency">${CLOCK_ICON}${latency}s</span>
                        </div>
                        <div class="image-item-prompt">${escapeHtml(r.prompt)}</div>
                        <div class="transcript-footer">
                            <a href="${imageUrl}" download class="play-btn" style="text-decoration:none;text-align:center;">download</a>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // ========== Vision functions ==========

        async function loadVisionStatus() {
            const res = await fetch('/api/vision/status');
            const status = await res.json();

            const dot = document.getElementById('vision-status-dot');
            dot.className = 'status-dot';
            if (status.loaded) {
                // green
            } else if (status.loading) {
                dot.classList.add('loading');
            } else {
                dot.classList.add('error');
            }

            document.getElementById('svc-model-short-vision').textContent =
                status.loaded ? status.model_short : 'loading...';
        }

        function onVisionFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            const preview = document.getElementById('vision-preview');
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = '<img src="' + e.target.result + '">';
            };
            reader.readAsDataURL(file);
            visionUploadedPath = null; // will upload on analyze
        }

        async function analyzeVision() {
            const fileInput = document.getElementById('vision-file-input');
            const prompt = document.getElementById('vision-prompt').value;
            const maxTokens = parseInt(document.getElementById('vision-max-tokens').value) || 512;
            const btn = document.getElementById('vision-analyze-btn');
            const btnText = document.getElementById('vision-analyze-btn-text');
            const resultDiv = document.getElementById('vision-result');

            if (!fileInput.files[0] && !visionUploadedPath) {
                alert('Select an image first');
                return;
            }

            btn.disabled = true;
            btnText.textContent = 'Analyzing...';
            resultDiv.style.display = 'none';

            try {
                // Upload if not already uploaded
                let imagePath = visionUploadedPath;
                if (!imagePath && fileInput.files[0]) {
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    const uploadRes = await fetch('/api/vision/upload', {
                        method: 'POST',
                        body: formData,
                    });
                    if (!uploadRes.ok) throw new Error('Upload failed: ' + await uploadRes.text());
                    const uploadData = await uploadRes.json();
                    imagePath = uploadData.path;
                    visionUploadedPath = imagePath;
                }

                const res = await fetch('/api/vision/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image: imagePath, prompt, max_tokens: maxTokens})
                });

                if (!res.ok) throw new Error(await res.text());

                const data = await res.json();
                document.getElementById('vision-result-text').textContent = data.response;
                resultDiv.style.display = 'block';

                loadVisionHistory();
                updateVisionStats();

            } catch(e) {
                alert('Vision failed: ' + e.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Analyze';
            }
        }

        async function loadVisionHistory() {
            const res = await fetch('/api/vision/history');
            const records = await res.json();
            if (records.length > _prevHistoryCounts.vision && _prevHistoryCounts.vision >= 0) flashServiceRow('vision');
            _prevHistoryCounts.vision = records.length;
            _lastHistoryData.vision = records;
            renderVisionHistory(sortHistoryRecords(records, historySortState.vision.field, historySortState.vision.ascending));
        }

        async function loadVisionHistoryForDate(date) {
            const res = await fetch('/api/vision/history');
            let records = await res.json();
            records = records.filter(r => r.timestamp.startsWith(date));
            _lastHistoryData.vision = records;
            renderVisionHistory(sortHistoryRecords(records, historySortState.vision.field, historySortState.vision.ascending));
        }

        function renderVisionHistory(records) {
            const container = document.getElementById('vision-history');
            if (!records.length) {
                container.innerHTML = '<div class="empty">no vision history</div>';
                return;
            }

            container.innerHTML = records.map(r => {
                const time = new Date(r.timestamp).toLocaleTimeString();
                const latency = (r.latency_ms / 1000).toFixed(1);
                const imageUrl = '/vision_output/' + r.image_file;

                return '<div class="vision-item">' +
                    '<img src="' + (_failedImages.has(imageUrl) ? '' : imageUrl) + '" class="vision-item-thumb' + (_failedImages.has(imageUrl) ? ' img-broken' : '') + '" onclick="window.open(\'' + imageUrl + '\', \'_blank\')" onerror="this.onerror=null;this.src=\'\';this.classList.add(\'img-broken\');_failedImages.add(\'' + imageUrl + '\')">' +
                    '<div class="vision-item-details">' +
                        '<div class="transcript-header">' +
                            '<span class="transcript-time">' + time + '</span>' +
                            '<span class="transcript-latency">' + CLOCK_ICON + latency + 's</span>' +
                        '</div>' +
                        '<div class="image-item-prompt">' + escapeHtml(r.prompt) + '</div>' +
                        '<div class="vision-response">' + escapeHtml(r.response_text) + '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function toggleVisionPause() {
            const action = visionPaused ? 'resume' : 'pause';
            fetch('/api/vision/server/' + action, {method: 'POST'})
                .then(() => {
                    visionPaused = !visionPaused;
                    loadVisionStatus();
                });
        }

        function restartVisionModel() {
            fetch('/api/vision/server/restart', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    alert('Vision model restarted');
                    loadVisionStatus();
                });
        }

        // ========== Stats helpers ==========
        async function updateTTSStats() {
            try {
                const res = await fetch('/api/tts/history');
                const records = await res.json();
                const today = new Date().toISOString().slice(0, 10);
                const todayRecords = records.filter(r => r.timestamp && r.timestamp.startsWith(today));
                const totalDur = records.reduce((s, r) => s + (r.audio_duration_ms || 0), 0);
                const todayDur = todayRecords.reduce((s, r) => s + (r.audio_duration_ms || 0), 0);
                document.getElementById('tts-stat-total').textContent = records.length + ' items';
                document.getElementById('tts-stat-total-duration').textContent = formatDurationHHMM(totalDur);
                document.getElementById('tts-stat-today').textContent = todayRecords.length + ' items';
                document.getElementById('tts-stat-today-duration').textContent = formatDurationHHMM(todayDur);
            } catch(e) {}
        }

        async function updateTranslateStats() {
            try {
                const res = await fetch('/api/translate/history');
                const records = await res.json();
                const today = new Date().toISOString().slice(0, 10);
                const todayRecords = records.filter(r => r.timestamp && r.timestamp.startsWith(today));
                document.getElementById('translate-stat-total').textContent = records.length + ' items';
                document.getElementById('translate-stat-today').textContent = todayRecords.length + ' items';
            } catch(e) {}
        }

        async function updateImageStats() {
            try {
                const res = await fetch('/api/image/history');
                const records = await res.json();
                const today = new Date().toISOString().slice(0, 10);
                const todayRecords = records.filter(r => r.timestamp && r.timestamp.startsWith(today));
                document.getElementById('image-stat-total').textContent = records.length + ' images';
                document.getElementById('image-stat-today').textContent = todayRecords.length + ' images';
            } catch(e) {}
        }

        async function updateVisionStats() {
            try {
                const res = await fetch('/api/vision/history');
                const records = await res.json();
                const today = new Date().toISOString().slice(0, 10);
                const todayRecords = records.filter(r => r.timestamp && r.timestamp.startsWith(today));
                document.getElementById('vision-stat-total').textContent = records.length + ' items';
                document.getElementById('vision-stat-today').textContent = todayRecords.length + ' items';
            } catch(e) {}
        }

        // Update a service dot: green=loaded, yellow=loading, red=not loaded
        function updateDot(dotId, loaded, loading) {
            const dot = document.getElementById(dotId);
            if (!dot) return;
            dot.className = 'status-dot';
            if (loaded) {
                // green (default)
            } else if (loading) {
                dot.classList.add('loading');
            } else {
                dot.classList.add('error');
            }
        }

        // Poll /health and update all 4 sidebar dots + model names
        let _allModelsReady = false;
        async function refreshServiceStatuses() {
            try {
                const health = await fetch('/health').then(r => r.json());

                // ASR
                updateDot('status-dot', health.loaded, !health.loaded);
                document.getElementById('svc-model-short-asr').textContent =
                    health.loaded ? health.model.split('/').pop() : 'loading...';

                // TTS
                updateDot('tts-status-dot', health.tts_loaded, !health.tts_loaded);
                document.getElementById('svc-model-short-tts').textContent =
                    health.tts_loaded ? health.tts_model.split('/').pop() : 'loading...';

                // Translate
                updateDot('translate-status-dot', health.translate_loaded, !health.translate_loaded);
                document.getElementById('svc-model-short-translate').textContent =
                    health.translate_loaded ? 'TranslateGemma' : 'loading...';

                // Image
                updateDot('image-status-dot', health.image_loaded, !health.image_loaded);
                document.getElementById('svc-model-short-image').textContent =
                    health.image_loaded ? health.image_model : 'loading...';

                // Vision
                updateDot('vision-status-dot', health.vision_loaded, !health.vision_loaded);
                document.getElementById('svc-model-short-vision').textContent =
                    health.vision_loaded ? health.vision_model.split('/').pop() : 'loading...';

                _allModelsReady = health.loaded && health.tts_loaded
                    && health.translate_loaded && health.image_loaded && health.vision_loaded;

                // Populate ASR model selector once loaded
                if (health.loaded) {
                    const asrSelect = document.getElementById('model-select');
                    if (asrSelect && asrSelect.options.length <= 1) {
                        const asrStatus = await fetch('/api/status').then(r => r.json());
                        asrSelect.innerHTML = asrStatus.available_models.map(m =>
                            `<option value="${m}" ${m === asrStatus.model ? 'selected' : ''}>${m.split('/').pop()}</option>`
                        ).join('');
                    }
                }
            } catch(e) {
                // Server not up yet - mark everything as loading
                ['status-dot', 'tts-status-dot', 'translate-status-dot', 'image-status-dot', 'vision-status-dot'].forEach(id => {
                    updateDot(id, false, true);
                });
            }

            // Load stats for all services
            updateTTSStats();
            updateTranslateStats();
            updateImageStats();
            updateVisionStats();
        }

        // ========== GPU stats ==========
        function fmtMB(mb) {
            if (mb >= 1024) return (mb / 1024).toFixed(1) + 'G';
            return mb + 'M';
        }

        function gpuBarClass(pct) {
            if (pct >= 70) return 'hot';
            if (pct >= 40) return 'warm';
            return 'cool';
        }

        function fmtGB(gb) { return gb >= 1000 ? (gb / 1000).toFixed(1) + 'T' : gb.toFixed(0) + 'G'; }
        function diskBarClass(pct) {
            if (pct >= 90) return 'hot';
            if (pct >= 75) return 'warm';
            return 'cool';
        }

        async function refreshGpuStats() {
            try {
                const res = await fetch('/api/gpu');
                const g = await res.json();

                // GPU utilization bar
                const util = g.gpu_utilization || 0;
                const utilBar = document.getElementById('gpu-util-bar');
                utilBar.style.width = util + '%';
                utilBar.className = 'gpu-bar-fill ' + gpuBarClass(util);
                document.getElementById('gpu-util-val').textContent = util + '%';

                // Memory bar (MLX active / total unified memory)
                const totalMB = (g.total_memory_gb || 0) * 1024;
                const mlxMB = g.metal_active_mb || 0;
                const memPct = totalMB > 0 ? Math.round(mlxMB / totalMB * 100) : 0;
                const memBar = document.getElementById('gpu-mem-bar');
                memBar.style.width = memPct + '%';
                memBar.className = 'gpu-bar-fill ' + gpuBarClass(memPct);
                document.getElementById('gpu-mem-val').textContent = fmtMB(mlxMB);

                // Device name
                if (g.device) {
                    document.getElementById('gpu-device-name').textContent = g.device.replace('Apple ', '');
                }

                // Disk bar
                if (g.disk_total_gb) {
                    const diskUsedPct = Math.round(g.disk_used_gb / g.disk_total_gb * 100);
                    const diskBar = document.getElementById('disk-bar');
                    diskBar.style.width = diskUsedPct + '%';
                    diskBar.className = 'gpu-bar-fill ' + diskBarClass(diskUsedPct);
                    document.getElementById('disk-val').textContent = fmtGB(g.disk_free_gb);
                }

                // USB bar (show/hide based on mount status)
                const usbRow = document.getElementById('usb-bar-row');
                if (g.usb_mounted) {
                    usbRow.style.display = '';
                    const usbUsedPct = Math.round(g.usb_used_gb / g.usb_total_gb * 100);
                    const usbBarEl = document.getElementById('usb-bar');
                    usbBarEl.style.width = usbUsedPct + '%';
                    usbBarEl.className = 'gpu-bar-fill ' + diskBarClass(usbUsedPct);
                    document.getElementById('usb-val').textContent = fmtGB(g.usb_free_gb);
                } else {
                    usbRow.style.display = 'none';
                }

                // Queue bar (total in-flight inference requests)
                const queueTotal = g.gpu_inflight || 0;
                const maxQueue = 5; // scale bar relative to 5
                const queuePct = Math.min(100, Math.round(queueTotal / maxQueue * 100));
                const queueBar = document.getElementById('queue-bar');
                queueBar.style.width = queuePct + '%';
                queueBar.className = 'gpu-bar-fill ' + (queueTotal >= 4 ? 'hot' : queueTotal >= 2 ? 'warm' : queueTotal >= 1 ? 'cool' : 'cool');
                document.getElementById('queue-val').textContent = queueTotal;

                // Sync server start epoch for uptime ticker
                if (g.uptime_s != null) {
                    _serverStartEpoch = Date.now() / 1000 - g.uptime_s;
                }
            } catch(e) {}
        }

        async function restartServer() {
            if (!confirm('Restart server? All models will reload.')) return;
            try {
                await fetch('/restart', { method: 'POST' });
            } catch(e) {}
            // Server will drop connection; wait and reload page
            document.getElementById('uptime-val').textContent = 'restarting...';
            setTimeout(() => {
                const poll = setInterval(async () => {
                    try {
                        const res = await fetch('/health');
                        if (res.ok) { clearInterval(poll); location.reload(); }
                    } catch(e) {}
                }, 1000);
            }, 2000);
        }

        // Theme switching
        function setTheme(mode) {
            localStorage.setItem('mls-theme', mode);
            applyTheme(mode);
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            const id = mode === 'auto' ? 'theme-auto' : mode === 'dark' ? 'theme-dark' : 'theme-light';
            document.getElementById(id).classList.add('active');
        }
        function applyTheme(mode) {
            if (mode === 'auto') {
                const dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', mode);
            }
        }
        (function initTheme() {
            const saved = localStorage.getItem('mls-theme') || 'light';
            applyTheme(saved);
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            const id = saved === 'auto' ? 'theme-auto' : saved === 'dark' ? 'theme-dark' : 'theme-light';
            document.getElementById(id).classList.add('active');
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (localStorage.getItem('mls-theme') === 'auto') applyTheme('auto');
            });
        })();

        // Log histogram chart + streaming
        let _logEventSource = null;
        async function refreshLogChart() {
            try {
                const res = await fetch('/api/logs/histogram');
                const data = await res.json();
                const hist = data.histogram; // [0]=now, [59]=59min ago
                const max = Math.max(...hist, 1);
                const chart = document.getElementById('log-chart');
                chart.innerHTML = hist.slice().reverse().map((v, i) => {
                    const h = v > 0 ? Math.max(2, Math.round(v / max * 18)) : 0;
                    return '<div class="log-chart-bar' + (v > 0 ? ' has-data' : '') + '" style="height:' + h + 'px"></div>';
                }).join('');
                document.getElementById('log-chart-count').textContent = data.total + ' lines/1h';
            } catch(e) {}
        }

        function connectLogStream() {
            if (_logEventSource) return; // already connected
            const body = document.getElementById('log-body');
            body.innerHTML = '';
            _logEventSource = new EventSource('/api/logs/stream');
            _logEventSource.onmessage = function(e) {
                const line = JSON.parse(e.data);
                const div = document.createElement('div');
                div.textContent = line;
                if (line.includes('[ERROR]')) div.className = 'log-line-error';
                else if (line.includes('[WARNING]') || line.includes('[WARN]')) div.className = 'log-line-warning';
                else if (line.includes('[INFO]')) div.className = 'log-line-info';
                body.appendChild(div);
                // Cap at 2000 lines to avoid memory bloat
                while (body.childNodes.length > 2000) body.removeChild(body.firstChild);
                body.scrollTop = body.scrollHeight;
            };
            _logEventSource.onerror = function() {};
        }

        function disconnectLogStream() {
            if (_logEventSource) {
                _logEventSource.close();
                _logEventSource = null;
            }
        }

        switchTab('asr');
        loadDates();
        initCalendar();
        refreshServiceStatuses();
        refreshGpuStats();
        refreshLogChart();

        // Auto-refresh: poll statuses + active tab data every 10s
        // Skip content refresh when audio is playing to avoid destroying DOM nodes
        // referenced by timeupdate/ended closures
        setInterval(() => {
            // Always poll service statuses (dots) until all models are ready
            if (!_allModelsReady) refreshServiceStatuses();
            refreshGpuStats();
            refreshLogChart();

            if (currentAudio && !currentAudio.paused) return;
            // Poll all services so flash triggers even on inactive tabs
            loadDates();
            loadTTSHistory();
            loadTranslateHistory();
            loadImageHistory();
            loadVisionHistory();
            // Update stats for active tab
            const activeTab = document.querySelector('.service-row.active')?.id?.replace('svc-row-', '');
            if (activeTab === 'tts') updateTTSStats();
            else if (activeTab === 'translate') updateTranslateStats();
            else if (activeTab === 'image') updateImageStats();
            else if (activeTab === 'vision') updateVisionStats();
        }, 3000);

        // Uptime ticker (1s)
        setInterval(() => {
            if (!_serverStartEpoch) return;
            const uptime = Math.floor(Date.now() / 1000 - _serverStartEpoch);
            const h = Math.floor(uptime / 3600);
            const m = Math.floor((uptime % 3600) / 60);
            const s = uptime % 60;
            document.getElementById('uptime-val').textContent =
                h > 0 ? h + 'h ' + m + 'm' : m > 0 ? m + 'm ' + s + 's' : s + 's';
        }, 1000);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            disconnectLogStream();
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        });
    </script>
</body>
</html>