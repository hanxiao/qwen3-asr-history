<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLX Serving</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #fafafa;
            color: #1a1f36;
            font-size: 14px;
        }
        .container { display: flex; height: 100vh; }
        .sidebar {
            width: 220px;
            background: #1a1f36;
            color: #fff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .logo {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px dashed #3a4060;
        }
        .logo svg { width: 28px; height: 28px; }
        .logo-text { font-weight: 600; font-size: 15px; }

        /* Service accordion rows */
        .service-rows {
            border-bottom: 1px dashed #3a4060;
        }
        .service-row {
            border-bottom: 1px dashed #3a4060;
            cursor: pointer;
            transition: background 0.15s;
        }
        .service-row:last-child { border-bottom: none; }
        .service-row:hover { background: rgba(255,255,255,0.03); }
        .service-row.active {
            background: rgba(226, 95, 74, 0.1);
            border-left: 3px dashed #e25f4a;
        }
        .svc-header-actions { margin-left: auto; display: flex; gap: 4px; }
        .icon-btn { background: none; border: 1px solid rgba(255,255,255,0.15); color: #6b7280; font-size: 10px; width: 22px; height: 22px; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; }
        .icon-btn:hover { color: #fff; border-color: rgba(255,255,255,0.3); }
        .service-row-header {
            padding: 10px 16px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .service-row.active .service-row-header { padding-left: 13px; }
        .service-row-name {
            font-weight: 600;
            font-size: 12px;
            color: #a0a8c0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex: 1;
        }
        .service-row.active .service-row-name { color: #fff; }
        .service-row-arrow {
            font-size: 10px;
            color: #4a5070;
            transition: transform 0.2s;
        }
        .service-row.expanded .service-row-arrow { transform: rotate(180deg); }
        .service-row-model {
            padding: 0 16px 10px;
            font-size: 10px;
            color: #4a5070;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .service-row.active .service-row-model { padding-left: 13px; }
        .service-row-details {
            display: none;
            padding: 0 16px 12px;
        }
        .service-row.active .service-row-details { padding-left: 13px; }
        .service-row.expanded .service-row-details { display: block; }
        .service-row-details .model-name-full {
            color: #a0a8c0;
            font-size: 10px;
            margin-bottom: 8px;
            word-break: break-all;
            line-height: 1.4;
        }
        .service-row-details .model-select {
            width: 100%;
            margin-bottom: 8px;
            padding: 5px 6px;
            background: rgba(255,255,255,0.05);
            border: 1px dashed #3a4060;
            color: #a0a8c0;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
        }
        .service-row-details .model-select:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .service-row-details .model-select option {
            background: #1a1f36;
            color: #fff;
        }
        .service-row-details .model-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }
        .service-row-details .svc-stats {
            font-size: 10px;
            color: #4a5070;
        }
        .service-row-details .svc-stats span { color: #e25f4a; }

        .sidebar-content { margin-top: auto; }
        
        /* Mini Calendar */
        .mini-calendar { padding: 8px 12px 12px; border-top: 1px dashed rgba(255,255,255,0.08); }
        .cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .cal-nav button { background: none; border: none; color: #6b7280; font: 11px 'JetBrains Mono', monospace; cursor: pointer; padding: 2px 6px; }
        .cal-nav button:hover { color: #fff; }
        .cal-nav .cal-month { color: #9ca3af; font: 11px 'JetBrains Mono', monospace; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; text-align: center; }
        .cal-header { color: #4b5563; font: 9px 'JetBrains Mono', monospace; padding: 2px 0; }
        .cal-day { font: 11px 'JetBrains Mono', monospace; padding: 3px 0; border-radius: 3px; color: #3a3f56; cursor: default; user-select: none; }
        .cal-day.has-data { color: #9ca3af; cursor: pointer; }
        .cal-day.has-data:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .cal-day.active { background: #e25f4a; color: #fff !important; }
        .cal-day.today:not(.active) { border-bottom: 1px solid #e25f4a; }

        /* Sidebar sub-content (dates etc) - only one visible at a time */
        .sidebar-sub { display: none; }

        .dates-container { flex: 1; overflow-y: auto; padding: 10px 0; }
        .date-item {
            padding: 10px 20px;
            cursor: pointer;
            color: #a0a8c0;
            transition: all 0.15s;
        }
        .date-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .date-item.active {
            color: #fff;
            background: #e25f4a;
        }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Main panel tabs */
        .main-content { flex: 1; overflow-y: auto; padding: 30px 40px; }

        .header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px dashed #d0d5dd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header h2 {
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sort-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .sort-label {
            font-size: 11px;
            color: #9ca3af;
        }
        .sort-btn {
            background: #fff;
            border: 1px dashed #d0d5dd;
            color: #6b7280;
            padding: 4px 10px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .sort-btn:hover {
            border-color: #e25f4a;
            color: #e25f4a;
        }
        .sort-btn.active {
            background: #e25f4a;
            border-color: #e25f4a;
            color: #fff;
        }
        .sort-btn svg {
            width: 10px;
            height: 10px;
        }
        .speed-controls {
            display: flex;
            gap: 4px;
            align-items: center;
            margin-left: 8px;
        }
        .speed-label {
            font-size: 11px;
            color: #9ca3af;
            margin-right: 4px;
        }
        .speed-btn {
            background: #fff;
            border: 1px dashed #d0d5dd;
            color: #6b7280;
            padding: 4px 8px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.15s;
            min-width: 28px;
            text-align: center;
        }
        .speed-btn:hover {
            border-color: #e25f4a;
            color: #e25f4a;
        }
        .speed-btn.active {
            background: #e25f4a;
            border-color: #e25f4a;
            color: #fff;
        }
        .transcript {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: border-color 0.15s;
        }
        .transcript:hover { border-color: #e25f4a; }
        .transcript-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        .transcript-time {
            color: #6b7280;
            font-size: 12px;
        }
        .transcript-latency {
            color: #e25f4a;
            font-size: 11px;
            padding: 2px 6px;
            background: #fef2f0;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .transcript-latency svg {
            width: 12px;
            height: 12px;
        }
        .transcript-model {
            color: #6b7280;
            font-size: 10px;
            padding: 2px 6px;
            background: #f3f4f6;
            border-radius: 3px;
            margin-left: auto;
        }
        .transcript-text {
            font-size: 15px;
            line-height: 1.6;
            color: #1a1f36;
        }
        .transcript-footer {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #e5e7eb;
        }
        .transcript-file {
            color: #9ca3af;
            font-size: 11px;
            flex: 1;
        }
        .play-btn {
            background: #1a1f36;
            color: white;
            border: none;
            padding: 6px 14px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s;
        }
        .play-btn:hover { background: #e25f4a; }
        .play-btn svg { width: 12px; height: 12px; }
        .waveform-container {
            position: relative;
            height: 48px;
            margin-top: 12px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
        }
        .waveform-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .waveform-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(226, 95, 74, 0.15);
            pointer-events: none;
            transition: width 0.1s linear;
        }
        .waveform-time {
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 10px;
            color: #6b7280;
            pointer-events: none;
        }
        .waveform-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            color: #9ca3af;
        }
        audio {
            display: none;
        }
        .empty {
            color: #9ca3af;
            text-align: center;
            padding: 60px 40px;
            border: 1px dashed #d0d5dd;
            background: #fff;
        }
        /* (old .stats removed - now inline in service row details) */

        /* Status dot used in service rows */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }
        .status-dot.paused {
            background: #fbbf24;
            animation: none;
        }
        .status-dot.loading {
            background: #fbbf24;
            animation: pulse 0.8s infinite;
        }
        .status-dot.error {
            background: #6b7280;
            animation: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .ctrl-btn {
            background: rgba(255,255,255,0.1);
            border: 1px dashed #3a4060;
            color: #a0a8c0;
            padding: 4px 8px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.15s;
        }
        .ctrl-btn:hover {
            background: #e25f4a;
            border-color: #e25f4a;
            color: #fff;
        }
        .ctrl-btn.active {
            background: #e25f4a;
            border-color: #e25f4a;
            color: #fff;
        }

        /* TTS panel styles */
        .tts-panel { display: none; }
        .tts-panel.active { display: block; }
        .asr-panel { display: block; }
        .translate-panel { display: none; }

        .tts-compose {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 20px;
            margin-bottom: 24px;
        }
        .tts-compose-header {
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        .tts-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            color: #1a1f36;
            background: #fafafa;
        }
        .tts-textarea:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .tts-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }
        .tts-select {
            padding: 8px 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #1a1f36;
            background: #fff;
            cursor: pointer;
        }
        .tts-select:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .synthesize-btn {
            background: #e25f4a;
            color: #fff;
            border: none;
            padding: 8px 20px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .synthesize-btn:hover { background: #d04a35; }
        .synthesize-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .synthesize-btn svg { width: 14px; height: 14px; }

        .tts-speed-input {
            width: 60px;
            padding: 8px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            text-align: center;
            color: #1a1f36;
        }
        .tts-speed-input:focus {
            outline: none;
            border-color: #e25f4a;
        }

        /* TTS history item (reuses transcript styles) */
        .tts-item {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: border-color 0.15s;
        }
        .tts-item:hover { border-color: #e25f4a; }

        .tts-voice-badge {
            color: #6b7280;
            font-size: 10px;
            padding: 2px 6px;
            background: #e8f4fd;
            border-radius: 3px;
        }
        .tts-lang-badge {
            color: #6b7280;
            font-size: 10px;
            padding: 2px 6px;
            background: #f0fdf4;
            border-radius: 3px;
        }

        /* TTS dates list (reuses dates-container) */

        /* Translate panel styles */
        .translate-compose {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 20px;
            margin-bottom: 24px;
        }
        .translate-compose-header {
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        .translate-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            color: #1a1f36;
            background: #fafafa;
        }
        .translate-textarea:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .translate-textarea[readonly] {
            background: #f3f4f6;
            color: #374151;
        }
        .translate-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }
        .translate-select {
            padding: 8px 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #1a1f36;
            background: #fff;
            cursor: pointer;
            max-width: 180px;
        }
        .translate-select:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .swap-btn {
            background: transparent;
            border: 1px dashed #d0d5dd;
            color: #6b7280;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .swap-btn:hover {
            border-color: #e25f4a;
            color: #e25f4a;
        }
        .translate-output-label {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 16px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .translate-item {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: border-color 0.15s;
        }
        .translate-item:hover { border-color: #e25f4a; }
        .translate-lang-badge {
            color: #6b7280;
            font-size: 10px;
            padding: 2px 6px;
            background: #f0e6ff;
            border-radius: 3px;
        }
        .translate-arrow {
            color: #9ca3af;
            font-size: 11px;
        }
        .translate-source-text {
            font-size: 13px;
            line-height: 1.5;
            color: #6b7280;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e5e7eb;
        }
        .translate-result-text {
            font-size: 15px;
            line-height: 1.6;
            color: #1a1f36;
        }

        /* File translate section */
        .file-translate-section {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 20px;
            margin-bottom: 24px;
        }
        .file-translate-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }
        .file-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #1a1f36;
            background: #fafafa;
        }
        .file-input:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .file-progress {
            margin-top: 12px;
            font-size: 11px;
            color: #6b7280;
        }
        .file-progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .file-progress-fill {
            height: 100%;
            background: #e25f4a;
            border-radius: 2px;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- MLX chip icon -->
                    <rect x="20" y="20" width="60" height="60" rx="8" fill="#e25f4a"/>
                    <!-- chip pins -->
                    <rect x="32" y="12" width="6" height="12" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="47" y="12" width="6" height="12" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="62" y="12" width="6" height="12" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="32" y="76" width="6" height="12" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="47" y="76" width="6" height="12" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="62" y="76" width="6" height="12" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="8" y="32" width="12" height="6" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="8" y="47" width="12" height="6" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="8" y="62" width="12" height="6" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="80" y="32" width="12" height="6" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="80" y="47" width="12" height="6" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <rect x="80" y="62" width="12" height="6" rx="2" fill="#e25f4a" opacity="0.6"/>
                    <!-- MLX text -->
                    <text x="50" y="56" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold" font-family="monospace">MLX</text>
                </svg>
                <span class="logo-text">mlx-serving</span>
            </div>

            <!-- Service accordion rows -->
            <div class="service-rows">
                <!-- ASR row -->
                <div class="service-row active expanded" id="svc-row-asr" onclick="onServiceRowClick(event, 'asr')">
                    <div class="service-row-header">
                        <div class="status-dot" id="status-dot"></div>
                        <span class="service-row-name">ASR</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="btn-pause" onclick="togglePause()" title="pause">&#9646;&#9646;</button>
                            <button class="icon-btn" id="btn-restart" onclick="restartModel()" title="restart">&#8635;</button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-asr">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="model-name-full" id="model-name" style="display:none">-</div>
                        <select class="model-select" id="model-select" onchange="switchModel(this.value)"></select>
                        <div class="svc-stats">
                            <div>total: <span id="stat-total">-</span> / <span id="stat-total-duration">-</span></div>
                            <div>today: <span id="stat-today">-</span> / <span id="stat-today-duration">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- TTS row -->
                <div class="service-row" id="svc-row-tts" onclick="onServiceRowClick(event, 'tts')">
                    <div class="service-row-header">
                        <div class="status-dot" id="tts-status-dot"></div>
                        <span class="service-row-name">TTS</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="tts-btn-pause" onclick="toggleTTSPause()" title="pause">&#9646;&#9646;</button>
                            <button class="icon-btn" id="tts-btn-restart" onclick="restartTTSModel()" title="restart">&#8635;</button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-tts">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="model-name-full" id="tts-model-name" style="display:none">-</div>
                        <select class="model-select" id="tts-model-select" onchange="switchTTSModel(this.value)"></select>
                        <div class="svc-stats">
                            <div>generated: <span id="tts-stat-total">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Translate row -->
                <div class="service-row" id="svc-row-translate" onclick="onServiceRowClick(event, 'translate')">
                    <div class="service-row-header">
                        <div class="status-dot" id="translate-status-dot"></div>
                        <span class="service-row-name">Translate</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="translate-btn-pause" onclick="toggleTranslatePause()" title="pause">&#9646;&#9646;</button>
                            <button class="icon-btn" id="translate-btn-restart" onclick="restartTranslateModel()" title="restart">&#8635;</button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-translate">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="model-name-full" id="translate-model-name" style="display:none">-</div>
                        <div class="svc-stats">
                            <div>translations: <span id="translate-stat-total">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-content">
                <div class="mini-calendar" id="mini-calendar">
                    <div class="cal-nav">
                        <button onclick="calPrevMonth()">&lt;</button>
                        <span class="cal-month" id="cal-month-label"></span>
                        <button onclick="calNextMonth()">&gt;</button>
                    </div>
                    <div class="cal-grid" id="cal-grid"></div>
                </div>
            </div>
        </div>

        <div class="main">
            <!-- ASR main panel -->
            <div class="main-content asr-panel" id="asr-panel">
                <div class="header">
                    <h2>Transcripts</h2>
                    <div class="header-controls">
                        <div class="sort-controls">
                            <span class="sort-label">sort:</span>
                            <button class="sort-btn active" id="sort-time" onclick="setSort('time')">
                                time
                                <svg id="sort-time-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg>
                            </button>
                            <button class="sort-btn" id="sort-length" onclick="setSort('length')">
                                length
                                <svg id="sort-length-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg>
                            </button>
                            <button class="sort-btn" id="sort-latency" onclick="setSort('latency')">
                                latency
                                <svg id="sort-latency-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg>
                            </button>
                        </div>
                        <div class="speed-controls">
                            <span class="speed-label">speed:</span>
                            <button class="speed-btn" data-speed="1" onclick="setSpeed(1)">1x</button>
                            <button class="speed-btn active" data-speed="2" onclick="setSpeed(2)">2x</button>
                            <button class="speed-btn" data-speed="4" onclick="setSpeed(4)">4x</button>
                        </div>
                    </div>
                </div>
                <div id="transcripts"><div class="empty">select a date to view transcripts</div></div>
            </div>

            <!-- TTS main panel -->
            <div class="main-content tts-panel" id="tts-panel">
                <div class="tts-compose">
                    <div class="tts-compose-header">Synthesize Speech</div>
                    <textarea class="tts-textarea" id="tts-text" placeholder="Enter text to synthesize..."></textarea>
                    <div class="tts-controls">
                        <select class="tts-select" id="tts-voice-select">
                            <option value="Chelsie">Chelsie (EN/F)</option>
                            <option value="Ethan">Ethan (EN/M)</option>
                            <option value="Vivian">Vivian (ZH/F)</option>
                        </select>
                        <select class="tts-select" id="tts-lang-select">
                            <option value="en">English</option>
                            <option value="zh">Chinese</option>
                            <option value="ja">Japanese</option>
                            <option value="ko">Korean</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="es">Spanish</option>
                            <option value="ru">Russian</option>
                            <option value="it">Italian</option>
                            <option value="pt">Portuguese</option>
                        </select>
                        <label style="font-size:11px;color:#9ca3af;">speed:</label>
                        <input type="number" class="tts-speed-input" id="tts-speed" value="1.0" min="0.5" max="2.0" step="0.1">
                        <button class="synthesize-btn" id="synthesize-btn" onclick="synthesize()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                            <span id="synthesize-btn-text">Synthesize</span>
                        </button>
                    </div>
                </div>

                <div class="header" style="margin-top: 0;">
                    <h2>TTS History</h2>
                </div>
                <div id="tts-history"><div class="empty">no TTS history yet</div></div>
            </div>

            <!-- Translate main panel -->
            <div class="main-content translate-panel" id="translate-panel">
                <div class="translate-compose">
                    <div class="translate-compose-header">Translate Text</div>
                    <div class="translate-controls">
                        <select class="translate-select" id="translate-source-lang"></select>
                        <button class="swap-btn" onclick="swapLanguages()" title="Swap languages">&#8644;</button>
                        <select class="translate-select" id="translate-target-lang"></select>
                        <button class="synthesize-btn" id="translate-btn" onclick="doTranslate()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0014.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>
                            <span id="translate-btn-text">Translate</span>
                        </button>
                    </div>
                    <textarea class="translate-textarea" id="translate-input" placeholder="Enter text to translate..."></textarea>
                    <div class="translate-output-label">Translation</div>
                    <textarea class="translate-textarea" id="translate-output" placeholder="Translation will appear here..." readonly></textarea>
                </div>

                <div class="file-translate-section">
                    <div class="translate-compose-header">File Translation</div>
                    <div class="file-translate-controls">
                        <input type="text" class="file-input" id="translate-file-path" placeholder="File path (e.g. ~/Documents/input.txt)">
                        <select class="translate-select" id="translate-file-source"></select>
                        <select class="translate-select" id="translate-file-target"></select>
                        <button class="synthesize-btn" id="translate-file-btn" onclick="startFileTranslate()">
                            <span id="translate-file-btn-text">Start</span>
                        </button>
                    </div>
                    <div class="file-progress" id="translate-file-progress" style="display:none;">
                        <span id="translate-file-progress-text">0 / 0 lines</span>
                        <div class="file-progress-bar">
                            <div class="file-progress-fill" id="translate-file-progress-fill" style="width:0%"></div>
                        </div>
                    </div>
                </div>

                <div class="header" style="margin-top: 0;">
                    <h2>Translation History</h2>
                </div>
                <div id="translate-history"><div class="empty">no translation history yet</div></div>
            </div>
        </div>
    </div>
    <script>
        // ========== Shared state ==========
        let currentTab = 'asr';
        let currentAudio = null;

        // ========== ASR state ==========
        let currentDate = null;
        let lastRecordCount = 0;
        let knownDates = [];
        let currentSort = 'time';
        let sortAscending = false;
        let currentSpeed = 2;

        // ========== TTS state ==========
        let ttsCurrentDate = null;
        let ttsHistory = [];
        let ttsPaused = false;

        // ========== Translate state ==========
        let translatePaused = false;
        let translateLanguages = [];
        let translateFilePolling = null;

        // ========== Tab switching ==========
        // ========== Mini Calendar ==========
        let calYear, calMonth; // 0-indexed month
        let calAvailableDates = {}; // {service: Set of 'YYYY-MM-DD'}
        
        function initCalendar() {
            const now = new Date();
            calYear = now.getFullYear();
            calMonth = now.getMonth();
            renderCalendar();
        }
        
        function calPrevMonth() {
            calMonth--;
            if (calMonth < 0) { calMonth = 11; calYear--; }
            renderCalendar();
        }
        
        function calNextMonth() {
            calMonth++;
            if (calMonth > 11) { calMonth = 0; calYear++; }
            renderCalendar();
        }
        
        function renderCalendar() {
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            document.getElementById('cal-month-label').textContent = months[calMonth] + ' ' + calYear;
            
            const grid = document.getElementById('cal-grid');
            const headers = ['Mo','Tu','We','Th','Fr','Sa','Su'];
            let html = headers.map(h => '<div class="cal-header">' + h + '</div>').join('');
            
            const firstDay = new Date(calYear, calMonth, 1);
            let startDay = firstDay.getDay() - 1; // Monday = 0
            if (startDay < 0) startDay = 6;
            const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
            const today = new Date().toISOString().slice(0, 10);
            const dates = calAvailableDates[currentTab] || new Set();
            
            for (let i = 0; i < startDay; i++) html += '<div class="cal-day"></div>';
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = calYear + '-' + String(calMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                const hasData = dates.has(dateStr);
                const isActive = (currentTab === 'asr' && dateStr === currentDate) ||
                                 (currentTab === 'tts' && dateStr === ttsCurrentDate);
                const isToday = dateStr === today;
                let cls = 'cal-day';
                if (hasData) cls += ' has-data';
                if (isActive) cls += ' active';
                if (isToday) cls += ' today';
                const onclick = hasData ? ' onclick="calSelectDate(\'' + dateStr + '\')"' : '';
                html += '<div class="' + cls + '"' + onclick + '>' + d + '</div>';
            }
            grid.innerHTML = html;
        }
        
        function calSelectDate(dateStr) {
            if (currentTab === 'asr') {
                currentDate = dateStr;
                loadTranscripts(dateStr);
            } else if (currentTab === 'tts') {
                ttsCurrentDate = dateStr;
                loadTTSHistoryForDate(dateStr);
            } else if (currentTab === 'translate') {
                loadTranslateHistoryForDate(dateStr);
            }
            renderCalendar();
        }
        
        async function loadCalendarDates(service) {
            try {
                if (service === 'asr') {
                    const res = await fetch('/api/dates');
                    const dates = await res.json();
                    calAvailableDates.asr = new Set(dates);
                } else if (service === 'tts') {
                    const res = await fetch('/api/tts/history');
                    const data = await res.json();
                    calAvailableDates.tts = new Set(data.dates || []);
                } else if (service === 'translate') {
                    const res = await fetch('/api/translate/history');
                    const data = await res.json();
                    calAvailableDates.translate = new Set(data.dates || []);
                }
            } catch(e) {
                calAvailableDates[service] = new Set();
            }
            renderCalendar();
        }

        function switchTab(tab) {
            currentTab = tab;

            // Update service row active state
            ['asr', 'tts', 'translate'].forEach(t => {
                const row = document.getElementById('svc-row-' + t);
                row.classList.toggle('active', t === tab);
            });

            // Update main panels
            document.getElementById('asr-panel').style.display = tab === 'asr' ? 'block' : 'none';
            document.getElementById('tts-panel').style.display = tab === 'tts' ? 'block' : 'none';
            document.getElementById('translate-panel').style.display = tab === 'translate' ? 'block' : 'none';

            // Refresh calendar for this service
            loadCalendarDates(tab);

            if (tab === 'tts') {
                loadTTSHistory();
                loadTTSStatus();
            }
            if (tab === 'translate') {
                loadTranslateLanguages();
                loadTranslateStatus();
                loadTranslateHistory();
            }
        }

        function onServiceRowClick(event, tab) {
            // Collapse all other rows, expand the clicked one
            document.querySelectorAll('.service-row').forEach(r => {
                if (r.id === 'svc-row-' + tab) {
                    r.classList.add('active', 'expanded');
                } else {
                    r.classList.remove('active', 'expanded');
                }
            });
            // Switch main content
            switchTab(tab);
        }

        // ========== ASR functions ==========

        function setSpeed(speed) {
            currentSpeed = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.speed) === speed);
            });
            if (currentAudio) {
                currentAudio.playbackRate = speed;
            }
        }

        async function loadDates() {
            const res = await fetch('/api/dates');
            const dates = await res.json();

            const hadNewDate = dates.length > knownDates.length;
            knownDates = dates;
            
            // Update calendar
            calAvailableDates.asr = new Set(dates);
            renderCalendar();

            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

            try {
                const todayRes = await fetch(`/api/transcripts/${today}`);
                if (todayRes.ok) {
                    const todayRecords = await todayRes.json();
                    document.getElementById('stat-today').textContent = todayRecords.length + ' items';
                    const todayDuration = todayRecords.reduce((sum, r) => sum + (r.audio_duration_ms || 0), 0);
                    document.getElementById('stat-today-duration').textContent = formatDurationHHMM(todayDuration);
                } else {
                    document.getElementById('stat-today').textContent = '0 items';
                    document.getElementById('stat-today-duration').textContent = '00:00';
                }
            } catch (e) {
                document.getElementById('stat-today').textContent = '0 items';
                document.getElementById('stat-today-duration').textContent = '00:00';
            }

            let totalDuration = 0;
            for (const date of dates) {
                try {
                    const res = await fetch(`/api/transcripts/${date}`);
                    if (res.ok) {
                        const records = await res.json();
                        totalDuration += records.reduce((sum, r) => sum + (r.audio_duration_ms || 0), 0);
                    }
                } catch (e) {}
            }
            document.getElementById('stat-total-duration').textContent = formatDurationHHMM(totalDuration);

            if (dates.includes(today)) {
                loadTranscripts(today);
            } else if (!currentDate || hadNewDate) {
                loadTranscripts(dates[0]);
            }

            document.getElementById('stat-total').textContent = dates.length + ' days';
        }

        async function loadTranscripts(date) {
            currentDate = date;
            document.querySelectorAll('#dates .date-item').forEach(el => {
                el.classList.toggle('active', el.dataset.date === date);
            });
            const res = await fetch(`/api/transcripts/${date}`);
            const records = await res.json();
            const container = document.getElementById('transcripts');

            const hadNewRecords = records.length > lastRecordCount;
            lastRecordCount = records.length;

            const now = new Date(); const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            if (date === today) {
                document.getElementById('stat-today').textContent = records.length + ' items';
            }

            if (records.length === 0) {
                container.innerHTML = '<div class="empty">no transcripts for this date</div>';
                return;
            }

            const sortedRecords = sortRecords(records);

            container.innerHTML = sortedRecords.map((r, i) => {
                const time = new Date(r.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                const latency = (r.latency_ms || r.duration_ms || 0) / 1000;
                const audioLen = (r.audio_duration_ms || 0) / 1000;
                const model = r.model || 'unknown';
                return `
                    <div class="transcript" data-audio-url="/audio/${date}/${r.audio_file}">
                        <div class="transcript-header">
                            <span class="transcript-time">${time}</span>
                            <span class="transcript-latency">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="12" cy="13" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 9v4l2.5 2.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <circle cx="10" cy="12" r="0.8"/><circle cx="14" cy="12" r="0.8"/>
                                    <path d="M10 15.5q2 1.5 4 0" fill="none" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
                                    <rect x="10" y="3" width="4" height="2" rx="0.5"/>
                                </svg>
                                ${latency.toFixed(1)}s
                            </span>
                            <span class="transcript-model">${model}</span>
                        </div>
                        <div class="transcript-text">${escapeHtml(r.text)}</div>
                        <div class="waveform-container" onclick="seekAudio(event, this)">
                            <canvas></canvas>
                            <div class="waveform-progress"></div>
                            <div class="waveform-time">0:00 / ${audioLen.toFixed(1)}s</div>
                            <div class="waveform-loading">loading waveform...</div>
                        </div>
                        <div class="transcript-footer">
                            <span class="transcript-file">${r.audio_file}</span>
                            <button class="play-btn" onclick="toggleAudio(this)">
                                <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                <span class="btn-text">play</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.transcript').forEach(el => loadWaveform(el));

            if (hadNewRecords) {
                container.scrollTop = container.scrollHeight;
            }
        }

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const waveformCache = new Map();

        async function loadWaveform(transcriptEl) {
            const url = transcriptEl.dataset.audioUrl;
            const container = transcriptEl.querySelector('.waveform-container');
            const canvas = container.querySelector('canvas');
            const loading = container.querySelector('.waveform-loading');
            const timeDisplay = container.querySelector('.waveform-time');

            try {
                let waveformData = waveformCache.get(url);
                let duration = 0;
                if (!waveformData) {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    waveformData = extractWaveform(audioBuffer, 100);
                    waveformData.duration = audioBuffer.duration;
                    waveformCache.set(url, waveformData);
                }
                duration = waveformData.duration || 0;
                if (duration > 0) {
                    timeDisplay.textContent = '0:00 / ' + duration.toFixed(1) + 's';
                }
                drawWaveform(canvas, waveformData, 0);
                loading.style.display = 'none';
            } catch (e) {
                loading.textContent = 'waveform unavailable';
            }
        }

        function extractWaveform(audioBuffer, samples) {
            const channelData = audioBuffer.getChannelData(0);
            const blockSize = Math.floor(channelData.length / samples);
            const waveform = [];
            for (let i = 0; i < samples; i++) {
                let sum = 0;
                for (let j = 0; j < blockSize; j++) {
                    sum += Math.abs(channelData[i * blockSize + j]);
                }
                waveform.push(sum / blockSize);
            }
            const max = Math.max(...waveform);
            return waveform.map(v => v / max);
        }

        function drawWaveform(canvas, data, progress) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.height;
            const barWidth = width / data.length;
            const progressIndex = Math.floor(progress * data.length);

            ctx.clearRect(0, 0, width, height);

            data.forEach((v, i) => {
                const barHeight = Math.max(2, v * (height - 8));
                const x = i * barWidth;
                const y = (height - barHeight) / 2;
                ctx.fillStyle = i < progressIndex ? '#e25f4a' : '#d0d5dd';
                ctx.fillRect(x + 1, y, barWidth - 2, barHeight);
            });
        }

        function toggleAudio(btn) {
            const transcript = btn.closest('.transcript') || btn.closest('.tts-item');
            const url = transcript.dataset.audioUrl;

            if (currentAudio && currentAudio.dataset.url === url) {
                if (currentAudio.paused) {
                    currentAudio.play();
                } else {
                    currentAudio.pause();
                }
                return;
            }

            if (currentAudio) {
                currentAudio.pause();
                resetTranscriptUI(currentAudio.transcriptEl);
            }

            const audio = new Audio(url);
            audio.dataset.url = url;
            audio.transcriptEl = transcript;
            currentAudio = audio;

            const container = transcript.querySelector('.waveform-container');
            const timeDisplay = container.querySelector('.waveform-time');
            const progressBar = container.querySelector('.waveform-progress');
            const canvas = container.querySelector('canvas');
            const playIcon = btn.querySelector('.icon-play');
            const pauseIcon = btn.querySelector('.icon-pause');
            const btnText = btn.querySelector('.btn-text');

            audio.ontimeupdate = () => {
                const progress = audio.currentTime / audio.duration;
                progressBar.style.width = (progress * 100) + '%';
                const current = formatTime(audio.currentTime);
                const total = formatTime(audio.duration);
                timeDisplay.textContent = current + ' / ' + total;
                const waveformData = waveformCache.get(url);
                if (waveformData) drawWaveform(canvas, waveformData, progress);
            };

            audio.onplay = () => {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                btnText.textContent = 'pause';
            };

            audio.onpause = () => {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                btnText.textContent = 'play';
            };

            audio.onended = () => {
                resetTranscriptUI(transcript);
                currentAudio = null;
            };

            audio.playbackRate = currentSpeed;
            audio.play();
        }

        function seekAudio(event, container) {
            const transcript = container.closest('.transcript') || container.closest('.tts-item');
            const url = transcript.dataset.audioUrl;
            const rect = container.getBoundingClientRect();
            const progress = (event.clientX - rect.left) / rect.width;

            if (currentAudio && currentAudio.dataset.url === url) {
                currentAudio.currentTime = progress * currentAudio.duration;
            } else {
                const btn = transcript.querySelector('.play-btn');
                toggleAudio(btn);
                currentAudio.oncanplay = () => {
                    currentAudio.currentTime = progress * currentAudio.duration;
                    currentAudio.oncanplay = null;
                };
            }
        }

        function resetTranscriptUI(transcript) {
            const container = transcript.querySelector('.waveform-container');
            const progressBar = container.querySelector('.waveform-progress');
            const canvas = container.querySelector('canvas');
            const btn = transcript.querySelector('.play-btn');
            const playIcon = btn.querySelector('.icon-play');
            const pauseIcon = btn.querySelector('.icon-pause');
            const btnText = btn.querySelector('.btn-text');

            progressBar.style.width = '0%';
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
            btnText.textContent = 'play';
            const url = transcript.dataset.audioUrl;
            const waveformData = waveformCache.get(url);
            if (waveformData) drawWaveform(canvas, waveformData, 0);
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return m + ':' + s.toString().padStart(2, '0');
        }

        function formatDurationHHMM(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
        }

        function sortRecords(records) {
            const sorted = [...records];
            if (currentSort === 'time') {
                sorted.sort((a, b) => {
                    const diff = new Date(a.timestamp) - new Date(b.timestamp);
                    return sortAscending ? diff : -diff;
                });
            } else if (currentSort === 'length') {
                sorted.sort((a, b) => {
                    const diff = (a.audio_duration_ms || 0) - (b.audio_duration_ms || 0);
                    return sortAscending ? diff : -diff;
                });
            } else if (currentSort === 'latency') {
                sorted.sort((a, b) => {
                    const diff = (a.latency_ms || a.duration_ms || 0) - (b.latency_ms || b.duration_ms || 0);
                    return sortAscending ? diff : -diff;
                });
            }
            return sorted;
        }

        function setSort(type) {
            if (currentSort === type) {
                sortAscending = !sortAscending;
            } else {
                currentSort = type;
                sortAscending = false;
            }

            document.getElementById('sort-time').classList.toggle('active', type === 'time');
            document.getElementById('sort-length').classList.toggle('active', type === 'length');
            document.getElementById('sort-latency').classList.toggle('active', type === 'latency');

            const upArrow = '<path d="M7 14l5-5 5 5z"/>';
            const downArrow = '<path d="M7 10l5 5 5-5z"/>';

            document.getElementById('sort-time-icon').innerHTML =
                (currentSort === 'time' && sortAscending) ? upArrow : downArrow;
            document.getElementById('sort-length-icon').innerHTML =
                (currentSort === 'length' && sortAscending) ? upArrow : downArrow;
            document.getElementById('sort-latency-icon').innerHTML =
                (currentSort === 'latency' && sortAscending) ? upArrow : downArrow;

            if (currentDate) {
                loadTranscripts(currentDate);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function autoRefresh() {
            if (currentAudio && !currentAudio.paused) return;
            if (currentTab !== 'asr') return;

            try {
                const res = await fetch('/api/dates');
                if (!res.ok) return;
                const dates = await res.json();

                if (JSON.stringify(dates) !== JSON.stringify(knownDates)) {
                    knownDates = dates;
                    const container = document.getElementById('dates');
                    container.innerHTML = dates.map(d =>
                        `<div class="date-item${d === currentDate ? ' active' : ''}" data-date="${d}">${d}</div>`
                    ).join('');
                    container.querySelectorAll('.date-item').forEach(el => {
                        el.onclick = () => loadTranscripts(el.dataset.date);
                    });
                    document.getElementById('stat-total').textContent = dates.length + ' days';
                }

                if (currentDate) {
                    const res2 = await fetch(`/api/transcripts/${currentDate}`);
                    if (res2.ok) {
                        const records = await res2.json();
                        if (records.length > lastRecordCount) {
                            lastRecordCount = records.length;
                            await loadTranscripts(currentDate);
                        }
                    }
                }

                const now = new Date(); const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
                const todayRes = await fetch(`/api/transcripts/${today}`);
                if (todayRes.ok) {
                    const todayRecords = await todayRes.json();
                    document.getElementById('stat-today').textContent = todayRecords.length + ' items';
                    const todayDuration = todayRecords.reduce((sum, r) => sum + (r.audio_duration_ms || 0), 0);
                    document.getElementById('stat-today-duration').textContent = formatDurationHHMM(todayDuration);
                }
            } catch (e) {}
        }

        // ========== ASR Model status ==========

        let serverPaused = false;

        async function loadStatus() {
            try {
                const res = await fetch('/api/status');
                const status = await res.json();

                const dot = document.getElementById('status-dot');
                const modelName = document.getElementById('model-name');
                const modelShort = document.getElementById('svc-model-short-asr');
                const pauseBtn = document.getElementById('btn-pause');
                const select = document.getElementById('model-select');

                serverPaused = status.paused;

                if (!status.loaded) {
                    dot.className = 'status-dot loading';
                    modelShort.textContent = 'loading model...';
                } else if (status.paused) {
                    dot.className = 'status-dot paused';
                    modelShort.textContent = status.model_short;
                    pauseBtn.textContent = 'resume';
                    pauseBtn.classList.add('active');
                } else {
                    dot.className = 'status-dot';
                    modelShort.textContent = status.model_short;
                    pauseBtn.textContent = 'pause';
                    pauseBtn.classList.remove('active');
                }

                modelName.textContent = status.model_short;

                if (select.options.length === 0) {
                    status.available_models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m;
                        opt.textContent = m.split('/').pop();
                        if (m === status.model) opt.selected = true;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                document.getElementById('status-dot').className = 'status-dot error';
                document.getElementById('svc-model-short-asr').textContent = 'offline';
            }
        }

        async function togglePause() {
            const dot = document.getElementById('status-dot');
            const modelShort = document.getElementById('svc-model-short-asr');

            dot.className = 'status-dot loading';
            modelShort.textContent = 'updating...';

            try {
                const endpoint = serverPaused ? '/api/server/resume' : '/api/server/pause';
                await fetch(endpoint, { method: 'POST' });
                await loadStatus();
            } catch (e) {
                modelShort.textContent = 'error';
            }
        }

        async function restartModel() {
            const dot = document.getElementById('status-dot');
            const modelShort = document.getElementById('svc-model-short-asr');
            const btn = document.getElementById('btn-restart');

            dot.className = 'status-dot loading';
            modelShort.textContent = 'restarting...';
            btn.classList.add('active');

            try {
                await fetch('/api/server/restart', { method: 'POST' });
                await loadStatus();
            } catch (e) {
                modelShort.textContent = 'error';
            }
            btn.classList.remove('active');
        }

        async function switchModel(modelName) {
            const dot = document.getElementById('status-dot');
            const modelShort = document.getElementById('svc-model-short-asr');

            dot.className = 'status-dot loading';
            modelShort.textContent = 'switching...';

            try {
                await fetch('/api/model/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName })
                });
                await loadStatus();
            } catch (e) {
                modelShort.textContent = 'error';
            }
        }

        // ========== TTS functions ==========

        async function loadTTSStatus() {
            try {
                const res = await fetch('/api/tts/status');
                const status = await res.json();

                const dot = document.getElementById('tts-status-dot');
                const modelName = document.getElementById('tts-model-name');
                const modelShort = document.getElementById('svc-model-short-tts');
                const pauseBtn = document.getElementById('tts-btn-pause');
                const select = document.getElementById('tts-model-select');

                ttsPaused = status.paused;

                if (status.loading) {
                    dot.className = 'status-dot loading';
                    modelShort.textContent = 'loading model...';
                } else if (!status.loaded) {
                    dot.className = 'status-dot error';
                    modelShort.textContent = 'not loaded';
                } else if (status.paused) {
                    dot.className = 'status-dot paused';
                    modelShort.textContent = status.model_short;
                    pauseBtn.textContent = 'resume';
                    pauseBtn.classList.add('active');
                } else {
                    dot.className = 'status-dot';
                    modelShort.textContent = status.model_short;
                    pauseBtn.textContent = 'pause';
                    pauseBtn.classList.remove('active');
                }

                modelName.textContent = status.model_short;

                if (select.options.length === 0) {
                    status.available_models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m;
                        opt.textContent = m.split('/').pop();
                        if (m === status.model) opt.selected = true;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                document.getElementById('tts-status-dot').className = 'status-dot error';
                document.getElementById('svc-model-short-tts').textContent = 'offline';
            }
        }

        async function toggleTTSPause() {
            const dot = document.getElementById('tts-status-dot');
            const modelShort = document.getElementById('svc-model-short-tts');

            dot.className = 'status-dot loading';
            modelShort.textContent = 'updating...';

            try {
                const endpoint = ttsPaused ? '/api/tts/server/resume' : '/api/tts/server/pause';
                await fetch(endpoint, { method: 'POST' });
                await loadTTSStatus();
            } catch (e) {
                modelShort.textContent = 'error';
            }
        }

        async function restartTTSModel() {
            const dot = document.getElementById('tts-status-dot');
            const modelShort = document.getElementById('svc-model-short-tts');
            const btn = document.getElementById('tts-btn-restart');

            dot.className = 'status-dot loading';
            modelShort.textContent = 'restarting...';
            btn.classList.add('active');

            try {
                await fetch('/api/tts/server/restart', { method: 'POST' });
                await loadTTSStatus();
            } catch (e) {
                modelShort.textContent = 'error';
            }
            btn.classList.remove('active');
        }

        async function switchTTSModel(modelName) {
            const dot = document.getElementById('tts-status-dot');
            const modelShort = document.getElementById('svc-model-short-tts');

            dot.className = 'status-dot loading';
            modelShort.textContent = 'switching...';

            try {
                await fetch('/api/tts/model/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName })
                });
                await loadTTSStatus();
            } catch (e) {
                modelShort.textContent = 'error';
            }
        }

        async function synthesize() {
            const textEl = document.getElementById('tts-text');
            const text = textEl.value.trim();
            if (!text) return;

            const voice = document.getElementById('tts-voice-select').value;
            const language = document.getElementById('tts-lang-select').value;
            const speed = parseFloat(document.getElementById('tts-speed').value) || 1.0;
            const btn = document.getElementById('synthesize-btn');
            const btnText = document.getElementById('synthesize-btn-text');

            btn.disabled = true;
            btnText.textContent = 'Generating...';

            try {
                const res = await fetch('/synthesize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, voice, language, speed })
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert('Error: ' + (err.detail || 'Unknown error'));
                    return;
                }

                const result = await res.json();
                await loadTTSHistory();

                setTimeout(() => {
                    const firstItem = document.querySelector('.tts-item');
                    if (firstItem) {
                        const playBtn = firstItem.querySelector('.play-btn');
                        if (playBtn) toggleAudio(playBtn);
                    }
                }, 200);

            } catch (e) {
                alert('Network error: ' + e.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Synthesize';
            }
        }

        async function loadTTSHistory() {
            try {
                const res = await fetch('/api/tts/history');
                const records = await res.json();
                ttsHistory = records;

                const container = document.getElementById('tts-history');

                if (records.length === 0) {
                    container.innerHTML = '<div class="empty">no TTS history yet</div>';
                    document.getElementById('tts-stat-total').textContent = '0 items';
                    return;
                }

                document.getElementById('tts-stat-total').textContent = records.length + ' items';

                const dates = [...new Set(records.map(r => r.date || r.timestamp.split('T')[0]))];
                const datesContainer = document.getElementById('tts-dates');
                datesContainer.innerHTML = dates.map(d =>
                    `<div class="date-item" data-date="${d}">${d}</div>`
                ).join('');

                container.innerHTML = records.map((r, i) => {
                    const time = new Date(r.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                    const date = r.date || r.timestamp.split('T')[0];
                    const latency = (r.latency_ms || 0) / 1000;
                    const audioLen = (r.audio_duration_ms || 0) / 1000;
                    const model = r.model || 'unknown';
                    const audioUrl = `/tts_audio/${r.audio_file}`;
                    return `
                        <div class="tts-item" data-audio-url="${audioUrl}">
                            <div class="transcript-header">
                                <span class="transcript-time">${date} ${time}</span>
                                <span class="transcript-latency">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="13" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <path d="M12 9v4l2.5 2.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    ${latency.toFixed(1)}s
                                </span>
                                <span class="tts-voice-badge">${escapeHtml(r.voice || '-')}</span>
                                <span class="tts-lang-badge">${escapeHtml(r.language || '-')}</span>
                                <span class="transcript-model">${model}</span>
                            </div>
                            <div class="transcript-text">${escapeHtml(r.text)}</div>
                            <div class="waveform-container" onclick="seekAudio(event, this)">
                                <canvas></canvas>
                                <div class="waveform-progress"></div>
                                <div class="waveform-time">0:00 / ${audioLen.toFixed(1)}s</div>
                                <div class="waveform-loading">loading waveform...</div>
                            </div>
                            <div class="transcript-footer">
                                <span class="transcript-file">${r.audio_file}</span>
                                <button class="play-btn" onclick="toggleAudio(this)">
                                    <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                    <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                    <span class="btn-text">play</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('.tts-item').forEach(el => loadWaveform(el));

            } catch (e) {
                console.error('Failed to load TTS history:', e);
            }
        }

        // ========== Translate functions ==========

        async function loadTranslateLanguages() {
            if (translateLanguages.length > 0) return;
            try {
                const res = await fetch('/languages');
                const data = await res.json();
                translateLanguages = data.data.languages;

                const selects = ['translate-source-lang', 'translate-target-lang', 'translate-file-source', 'translate-file-target'];
                selects.forEach(id => {
                    const sel = document.getElementById(id);
                    if (sel.options.length > 0) return;
                    translateLanguages.forEach(lang => {
                        const opt = document.createElement('option');
                        opt.value = lang.language;
                        opt.textContent = lang.name + ' (' + lang.language + ')';
                        sel.appendChild(opt);
                    });
                });

                // Set defaults: en -> zh
                document.getElementById('translate-source-lang').value = 'en';
                document.getElementById('translate-target-lang').value = 'zh';
                document.getElementById('translate-file-source').value = 'en';
                document.getElementById('translate-file-target').value = 'zh';
            } catch (e) {
                console.error('Failed to load languages:', e);
            }
        }

        async function loadTranslateStatus() {
            try {
                const res = await fetch('/api/translate/status');
                const status = await res.json();

                const dot = document.getElementById('translate-status-dot');
                const modelName = document.getElementById('translate-model-name');
                const modelShort = document.getElementById('svc-model-short-translate');
                const pauseBtn = document.getElementById('translate-btn-pause');

                translatePaused = status.paused;

                if (status.loading) {
                    dot.className = 'status-dot loading';
                    modelShort.textContent = 'loading model...';
                } else if (!status.loaded) {
                    dot.className = 'status-dot error';
                    modelShort.textContent = 'not loaded';
                } else if (status.paused) {
                    dot.className = 'status-dot paused';
                    modelShort.textContent = status.model;
                    pauseBtn.textContent = 'resume';
                    pauseBtn.classList.add('active');
                } else {
                    dot.className = 'status-dot';
                    modelShort.textContent = status.model;
                    pauseBtn.textContent = 'pause';
                    pauseBtn.classList.remove('active');
                }

                modelName.textContent = status.model;
            } catch (e) {
                document.getElementById('translate-status-dot').className = 'status-dot error';
                document.getElementById('svc-model-short-translate').textContent = 'offline';
            }
        }

        async function toggleTranslatePause() {
            const dot = document.getElementById('translate-status-dot');
            const modelShort = document.getElementById('svc-model-short-translate');

            dot.className = 'status-dot loading';
            modelShort.textContent = 'updating...';

            try {
                const endpoint = translatePaused ? '/api/translate/server/resume' : '/api/translate/server/pause';
                await fetch(endpoint, { method: 'POST' });
                await loadTranslateStatus();
            } catch (e) {
                modelShort.textContent = 'error';
            }
        }

        async function restartTranslateModel() {
            const dot = document.getElementById('translate-status-dot');
            const modelShort = document.getElementById('svc-model-short-translate');
            const btn = document.getElementById('translate-btn-restart');

            dot.className = 'status-dot loading';
            modelShort.textContent = 'restarting...';
            btn.classList.add('active');

            try {
                await fetch('/api/translate/server/restart', { method: 'POST' });
                await loadTranslateStatus();
            } catch (e) {
                modelShort.textContent = 'error';
            }
            btn.classList.remove('active');
        }

        function swapLanguages() {
            const src = document.getElementById('translate-source-lang');
            const tgt = document.getElementById('translate-target-lang');
            const tmp = src.value;
            src.value = tgt.value;
            tgt.value = tmp;
        }

        async function doTranslate() {
            const text = document.getElementById('translate-input').value.trim();
            if (!text) return;

            const source = document.getElementById('translate-source-lang').value;
            const target = document.getElementById('translate-target-lang').value;
            const btn = document.getElementById('translate-btn');
            const btnText = document.getElementById('translate-btn-text');
            const output = document.getElementById('translate-output');

            btn.disabled = true;
            btnText.textContent = 'Translating...';
            output.value = '';

            try {
                const res = await fetch('/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ q: text, source, target })
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert('Error: ' + (err.detail || 'Unknown error'));
                    return;
                }

                const result = await res.json();
                if (result.data && result.data.translations && result.data.translations.length > 0) {
                    output.value = result.data.translations[0].translatedText;
                }

                await loadTranslateHistory();
            } catch (e) {
                alert('Network error: ' + e.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Translate';
            }
        }

        async function startFileTranslate() {
            const filePath = document.getElementById('translate-file-path').value.trim();
            if (!filePath) { alert('Enter a file path'); return; }

            const source = document.getElementById('translate-file-source').value;
            const target = document.getElementById('translate-file-target').value;
            const btn = document.getElementById('translate-file-btn');
            const btnText = document.getElementById('translate-file-btn-text');

            btn.disabled = true;
            btnText.textContent = 'Starting...';

            try {
                const res = await fetch('/translate/file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file: filePath, source, target })
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert('Error: ' + (err.detail || 'Unknown error'));
                    btn.disabled = false;
                    btnText.textContent = 'Start';
                    return;
                }

                const result = await res.json();
                const outputPath = result.output;

                document.getElementById('translate-file-progress').style.display = 'block';

                // Poll progress
                if (translateFilePolling) clearInterval(translateFilePolling);
                translateFilePolling = setInterval(async () => {
                    try {
                        const statusRes = await fetch('/translate/file/status?output=' + encodeURIComponent(outputPath));
                        const status = await statusRes.json();
                        const pct = status.lines > 0 ? Math.round((status.done / status.lines) * 100) : 0;
                        document.getElementById('translate-file-progress-text').textContent =
                            status.done + ' / ' + status.lines + ' lines' + (status.status === 'done' ? ' - DONE' : '');
                        document.getElementById('translate-file-progress-fill').style.width = pct + '%';

                        if (status.status === 'done') {
                            clearInterval(translateFilePolling);
                            translateFilePolling = null;
                            btn.disabled = false;
                            btnText.textContent = 'Start';
                        }
                    } catch (e) {}
                }, 1000);

            } catch (e) {
                alert('Network error: ' + e.message);
                btn.disabled = false;
                btnText.textContent = 'Start';
            }
        }

        async function loadTranslateHistory() {
            try {
                const res = await fetch('/api/translate/history');
                const records = await res.json();

                const container = document.getElementById('translate-history');

                if (records.length === 0) {
                    container.innerHTML = '<div class="empty">no translation history yet</div>';
                    document.getElementById('translate-stat-total').textContent = '0 items';
                    return;
                }

                document.getElementById('translate-stat-total').textContent = records.length + ' items';

                // Build dates sidebar
                const dates = [...new Set(records.map(r => r.date || r.timestamp.split('T')[0]))];
                const datesContainer = document.getElementById('translate-dates');
                datesContainer.innerHTML = dates.map(d =>
                    `<div class="date-item">${d}</div>`
                ).join('');

                container.innerHTML = records.slice(0, 100).map((r, i) => {
                    const time = new Date(r.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                    const date = r.date || r.timestamp.split('T')[0];
                    const latency = (r.latency_ms || 0) / 1000;
                    const srcLang = r.source_lang_name || r.source_lang || '?';
                    const tgtLang = r.target_lang_name || r.target_lang || '?';
                    return `
                        <div class="translate-item">
                            <div class="transcript-header">
                                <span class="transcript-time">${date} ${time}</span>
                                <span class="transcript-latency">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="13" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                                        <path d="M12 9v4l2.5 2.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    ${latency.toFixed(2)}s
                                </span>
                                <span class="translate-lang-badge">${escapeHtml(srcLang)}</span>
                                <span class="translate-arrow">&rarr;</span>
                                <span class="translate-lang-badge">${escapeHtml(tgtLang)}</span>
                                <span class="transcript-model">${escapeHtml(r.model || '')}</span>
                            </div>
                            <div class="translate-source-text">${escapeHtml(r.source_text || '')}</div>
                            <div class="translate-result-text">${escapeHtml(r.translated_text || '')}</div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Failed to load translate history:', e);
            }
        }

        // ========== Init ==========
        initCalendar();
        loadDates();
        loadStatus();
        loadTTSStatus();
        loadTranslateStatus();
        setInterval(autoRefresh, 3000);
        setInterval(loadStatus, 5000);
        setInterval(() => { if (currentTab === 'tts') loadTTSStatus(); }, 5000);
        setInterval(() => { if (currentTab === 'translate') loadTranslateStatus(); }, 5000);
    </script>
</body>
</html>
