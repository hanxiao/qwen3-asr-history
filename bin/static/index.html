<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLX Serving</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #fafafa;
            color: #1a1f36;
            font-size: 14px;
        }
        .container { display: flex; height: 100vh; }
        .sidebar {
            width: 220px;
            background: #1a1f36;
            color: #fff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .logo {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px dashed #3a4060;
        }
        .logo svg { width: 28px; height: 28px; }
        .logo-text { font-weight: 600; font-size: 15px; }

        /* Service accordion rows */
        .service-rows {
            border-bottom: 1px dashed #3a4060;
        }
        .service-row {
            border-bottom: 1px dashed #3a4060;
            cursor: pointer;
            transition: background 0.15s;
        }
        .service-row:last-child { border-bottom: none; }
        .service-row:hover { background: rgba(255,255,255,0.03); }
        .service-row.active {
            background: rgba(226, 95, 74, 0.1);
            border-left: 3px dashed #e25f4a;
        }
        .svc-header-actions { margin-left: auto; display: none; gap: 4px; }
        .service-row.expanded .svc-header-actions { display: flex; }
        .icon-btn { background: none; border: 1px solid transparent; color: #6b7280; font-size: 10px; width: 22px; height: 22px; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; }
        .icon-btn:hover { color: #fff; border-color: rgba(255,255,255,0.25); }
        .service-row-header {
            padding: 10px 16px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .service-row.active .service-row-header { padding-left: 13px; }
        .service-row-name {
            font-weight: 600;
            font-size: 12px;
            color: #a0a8c0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex: 1;
        }
        .service-row.active .service-row-name { color: #fff; }
        .service-row-arrow {
            font-size: 10px;
            color: #4a5070;
            transition: transform 0.2s;
        }
        .service-row.expanded .service-row-arrow { transform: rotate(180deg); }
        .service-row-model {
            padding: 0 16px 10px;
            font-size: 10px;
            color: #4a5070;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .service-row.active .service-row-model { padding-left: 13px; }
        .service-row-details {
            display: none;
            padding: 0 16px 12px;
        }
        .service-row.active .service-row-details { padding-left: 13px; }
        .service-row.expanded .service-row-details { display: block; }
        .service-row-details .model-name-full {
            color: #a0a8c0;
            font-size: 10px;
            margin-bottom: 8px;
            word-break: break-all;
            line-height: 1.4;
        }
        .service-row-details .model-select {
            width: 100%;
            margin-bottom: 8px;
            padding: 5px 6px;
            background: rgba(255,255,255,0.05);
            border: 1px dashed #3a4060;
            color: #a0a8c0;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
        }
        .service-row-details .model-select:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .service-row-details .model-select option {
            background: #1a1f36;
            color: #fff;
        }
        .service-row-details .model-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }
        .service-row-details .svc-stats {
            font-size: 10px;
            color: #4a5070;
        }
        .service-row-details .svc-stats span { color: #e25f4a; }

        .sidebar-content { margin-top: auto; }
        
        /* Mini Calendar */
        .mini-calendar { padding: 8px 12px 12px; border-top: 1px dashed rgba(255,255,255,0.08); }
        .cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .cal-nav button { background: none; border: none; color: #6b7280; font: 11px 'JetBrains Mono', monospace; cursor: pointer; padding: 2px 6px; }
        .cal-nav button:hover { color: #fff; }
        .cal-nav .cal-month { color: #9ca3af; font: 11px 'JetBrains Mono', monospace; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; text-align: center; }
        .cal-header { color: #4b5563; font: 9px 'JetBrains Mono', monospace; padding: 2px 0; }
        .cal-day { font: 11px 'JetBrains Mono', monospace; padding: 3px 0; border-radius: 3px; color: #3a3f56; cursor: default; user-select: none; }
        .cal-day.has-data { color: #9ca3af; cursor: pointer; }
        .cal-day.has-data:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .cal-day.active { background: #e25f4a; color: #fff !important; }
        .cal-day.today:not(.active) { border-bottom: 1px solid #e25f4a; }

        /* Sidebar sub-content (dates etc) - only one visible at a time */
        .sidebar-sub { display: none; }

        .dates-container { flex: 1; overflow-y: auto; padding: 10px 0; }
        .date-item {
            padding: 10px 20px;
            cursor: pointer;
            color: #a0a8c0;
            transition: all 0.15s;
        }
        .date-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .date-item.active {
            color: #fff;
            background: #e25f4a;
        }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Main panel tabs */
        .main-content { flex: 1; overflow-y: auto; padding: 30px 40px; }

        .header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px dashed #d0d5dd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header h2 {
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sort-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .sort-label {
            font-size: 11px;
            color: #9ca3af;
        }
        .sort-btn {
            background: #fff;
            border: 1px dashed #d0d5dd;
            color: #6b7280;
            padding: 4px 10px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .sort-btn:hover {
            border-color: #e25f4a;
            color: #e25f4a;
        }
        .sort-btn.active {
            background: #e25f4a;
            border-color: #e25f4a;
            color: #fff;
        }
        .sort-btn svg {
            width: 10px;
            height: 10px;
        }
        .speed-controls {
            display: flex;
            gap: 4px;
            align-items: center;
            margin-left: 8px;
        }
        .speed-label {
            font-size: 11px;
            color: #9ca3af;
            margin-right: 4px;
        }
        .speed-btn {
            background: #fff;
            border: 1px dashed #d0d5dd;
            color: #6b7280;
            padding: 4px 8px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.15s;
            min-width: 28px;
            text-align: center;
        }
        .speed-btn:hover {
            border-color: #e25f4a;
            color: #e25f4a;
        }
        .speed-btn.active {
            background: #e25f4a;
            border-color: #e25f4a;
            color: #fff;
        }
        .transcript {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: border-color 0.15s;
        }
        .transcript:hover { border-color: #e25f4a; }
        .transcript-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        .transcript-time {
            color: #6b7280;
            font-size: 12px;
        }
        .transcript-latency {
            color: #e25f4a;
            font-size: 11px;
            padding: 2px 6px;
            background: #fef2f0;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .transcript-latency svg {
            width: 12px;
            height: 12px;
        }
        .transcript-model {
            color: #6b7280;
            font-size: 10px;
            padding: 2px 6px;
            background: #f3f4f6;
            border-radius: 3px;
            margin-left: auto;
        }
        .transcript-text {
            font-size: 15px;
            line-height: 1.6;
            color: #1a1f36;
        }
        .transcript-footer {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #e5e7eb;
        }
        .transcript-file {
            color: #9ca3af;
            font-size: 11px;
            flex: 1;
        }
        .play-btn {
            background: #1a1f36;
            color: white;
            border: none;
            padding: 6px 14px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s;
        }
        .play-btn:hover { background: #e25f4a; }
        .play-btn svg { width: 12px; height: 12px; }
        .waveform-container {
            position: relative;
            height: 48px;
            margin-top: 12px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
        }
        .waveform-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .waveform-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(226, 95, 74, 0.15);
            pointer-events: none;
            transition: width 0.1s linear;
        }
        .waveform-time {
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 10px;
            color: #6b7280;
            pointer-events: none;
        }
        .waveform-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            color: #9ca3af;
        }
        audio {
            display: none;
        }
        .empty {
            color: #9ca3af;
            text-align: center;
            padding: 60px 40px;
            border: 1px dashed #d0d5dd;
            background: #fff;
        }
        /* (old .stats removed - now inline in service row details) */

        /* Status dot used in service rows */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }
        .status-dot.paused {
            background: #fbbf24;
            animation: none;
        }
        .status-dot.loading {
            background: #fbbf24;
            animation: pulse 0.8s infinite;
        }
        .status-dot.error {
            background: #6b7280;
            animation: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .ctrl-btn {
            background: rgba(255,255,255,0.1);
            border: 1px dashed #3a4060;
            color: #a0a8c0;
            padding: 4px 8px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.15s;
        }
        .ctrl-btn:hover {
            background: #e25f4a;
            border-color: #e25f4a;
            color: #fff;
        }
        .ctrl-btn.active {
            background: #e25f4a;
            border-color: #e25f4a;
            color: #fff;
        }

        /* TTS panel styles */
        .tts-panel { display: none; }
        .tts-panel.active { display: block; }
        .asr-panel { display: block; }
        .translate-panel { display: none; }
        .image-panel { display: none; }

        .tts-compose {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 20px;
            margin-bottom: 24px;
        }
        .tts-compose-header {
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        .tts-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            color: #1a1f36;
            background: #fafafa;
        }
        .tts-textarea:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .tts-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }
        .tts-select {
            padding: 8px 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #1a1f36;
            background: #fff;
            cursor: pointer;
        }
        .tts-select:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .synthesize-btn {
            background: #e25f4a;
            color: #fff;
            border: none;
            padding: 8px 20px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .synthesize-btn:hover { background: #d04a35; }
        .synthesize-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .synthesize-btn svg { width: 14px; height: 14px; }

        .tts-speed-input {
            width: 60px;
            padding: 8px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            text-align: center;
            color: #1a1f36;
        }
        .tts-speed-input:focus {
            outline: none;
            border-color: #e25f4a;
        }

        /* TTS history item (reuses transcript styles) */
        .tts-item {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: border-color 0.15s;
        }
        .tts-item:hover { border-color: #e25f4a; }

        .tts-voice-badge {
            color: #6b7280;
            font-size: 10px;
            padding: 2px 6px;
            background: #e8f4fd;
            border-radius: 3px;
        }
        .tts-lang-badge {
            color: #6b7280;
            font-size: 10px;
            padding: 2px 6px;
            background: #f0fdf4;
            border-radius: 3px;
        }

        /* Translate panel styles */
        .translate-compose {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 20px;
            margin-bottom: 24px;
        }
        .translate-compose-header {
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        .translate-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            color: #1a1f36;
            background: #fafafa;
        }
        .translate-textarea:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .translate-textarea[readonly] {
            background: #f3f4f6;
            color: #374151;
        }
        .translate-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }
        .translate-select {
            padding: 8px 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #1a1f36;
            background: #fff;
            cursor: pointer;
            max-width: 180px;
        }
        .translate-select:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .swap-btn {
            background: transparent;
            border: 1px dashed #d0d5dd;
            color: #6b7280;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .swap-btn:hover {
            border-color: #e25f4a;
            color: #e25f4a;
        }
        .translate-output-label {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 16px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .translate-item {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: border-color 0.15s;
        }
        .translate-item:hover { border-color: #e25f4a; }
        .translate-lang-badge {
            color: #6b7280;
            font-size: 10px;
            padding: 2px 6px;
            background: #f0e6ff;
            border-radius: 3px;
        }
        .translate-arrow {
            color: #9ca3af;
            font-size: 11px;
        }
        .translate-source-text {
            font-size: 13px;
            line-height: 1.5;
            color: #6b7280;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e5e7eb;
        }
        .translate-result-text {
            font-size: 15px;
            line-height: 1.6;
            color: #1a1f36;
        }

        /* File translate section */
        .file-translate-section {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 20px;
            margin-bottom: 24px;
        }
        .file-translate-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }
        .file-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px dashed #d0d5dd;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #1a1f36;
            background: #fafafa;
        }
        .file-input:focus {
            outline: none;
            border-color: #e25f4a;
        }
        .file-progress {
            margin-top: 12px;
            font-size: 11px;
            color: #6b7280;
        }
        .file-progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .file-progress-fill {
            height: 100%;
            background: #e25f4a;
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        /* Image panel styles */
        .image-compose {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 20px;
            margin-bottom: 24px;
        }
        .image-result {
            margin-top: 20px;
            text-align: center;
            border-top: 1px dashed #e5e7eb;
            padding-top: 20px;
        }
        .image-result img {
            max-width: 100%;
            max-height: 500px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .image-item {
            background: #fff;
            border: 1px dashed #d0d5dd;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .image-item-thumb {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            background: #f3f4f6;
            cursor: pointer;
        }
        .image-item-details { flex: 1; }
        .image-item-prompt {
            font-size: 13px;
            line-height: 1.5;
            color: #1a1f36;
            margin-bottom: 8px;
        }
        .image-item-meta {
            font-size: 11px;
            color: #6b7280;
            display: flex;
            gap: 12px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <svg width="28" height="28" viewBox="0 0 14 14" shape-rendering="crispEdges">
                    <rect x="2" y="3" width="2" height="2" fill="#e25f4a"/>
                    <rect x="10" y="3" width="2" height="2" fill="#e25f4a"/>
                    <rect x="3" y="5" width="8" height="6" fill="#e25f4a"/>
                    <rect x="2" y="6" width="10" height="4" fill="#e25f4a"/>
                    <rect x="4" y="7" width="1" height="1" fill="#1a1f36"/>
                    <rect x="9" y="7" width="1" height="1" fill="#1a1f36"/>
                    <rect x="6" y="8" width="2" height="1" fill="rgba(255,255,255,0.4)"/>
                    <rect x="3" y="5" width="1" height="1" fill="rgba(255,255,255,0.2)"/>
                </svg>
                <span class="logo-text" style="font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; font-weight: 700;">MLS</span>
            </div>

            <!-- Service accordion rows -->
            <div class="service-rows">
                <!-- ASR row -->
                <div class="service-row active expanded" id="svc-row-asr" onclick="onServiceRowClick(event, 'asr')">
                    <div class="service-row-header">
                        <div class="status-dot" id="status-dot"></div>
                        <span class="service-row-name">ASR</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="btn-pause" onclick="togglePause()" title="pause"><svg width="10" height="10" viewBox="0 0 10 10"><rect x="1" y="1" width="3" height="8" fill="currentColor"/><rect x="6" y="1" width="3" height="8" fill="currentColor"/></svg></button>
                            <button class="icon-btn" id="btn-restart" onclick="restartModel()" title="restart"><svg width="10" height="10" viewBox="0 0 10 10"><path d="M5 1a4 4 0 1 0 4 4" stroke="currentColor" fill="none" stroke-width="1.5"/><path d="M7 1l2 4h-4z" fill="currentColor"/></svg></button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-asr">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="model-name-full" id="model-name" style="display:none">-</div>
                        <select class="model-select" id="model-select" onchange="switchModel(this.value)"></select>
                        <div class="svc-stats">
                            <div>total: <span id="stat-total">-</span> / <span id="stat-total-duration">-</span></div>
                            <div>today: <span id="stat-today">-</span> / <span id="stat-today-duration">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- TTS row -->
                <div class="service-row" id="svc-row-tts" onclick="onServiceRowClick(event, 'tts')">
                    <div class="service-row-header">
                        <div class="status-dot" id="tts-status-dot"></div>
                        <span class="service-row-name">TTS</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="tts-btn-pause" onclick="toggleTTSPause()" title="pause"><svg width="10" height="10" viewBox="0 0 10 10"><rect x="1" y="1" width="3" height="8" fill="currentColor"/><rect x="6" y="1" width="3" height="8" fill="currentColor"/></svg></button>
                            <button class="icon-btn" id="tts-btn-restart" onclick="restartTTSModel()" title="restart"><svg width="10" height="10" viewBox="0 0 10 10"><path d="M5 1a4 4 0 1 0 4 4" stroke="currentColor" fill="none" stroke-width="1.5"/><path d="M7 1l2 4h-4z" fill="currentColor"/></svg></button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-tts">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="model-name-full" id="tts-model-name" style="display:none">-</div>
                        <select class="model-select" id="tts-model-select" onchange="switchTTSModel(this.value)"></select>
                        <div class="svc-stats">
                            <div>generated: <span id="tts-stat-total">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Translate row -->
                <div class="service-row" id="svc-row-translate" onclick="onServiceRowClick(event, 'translate')">
                    <div class="service-row-header">
                        <div class="status-dot" id="translate-status-dot"></div>
                        <span class="service-row-name">Translate</span>
                        <span class="svc-header-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" id="translate-btn-pause" onclick="toggleTranslatePause()" title="pause"><svg width="10" height="10" viewBox="0 0 10 10"><rect x="1" y="1" width="3" height="8" fill="currentColor"/><rect x="6" y="1" width="3" height="8" fill="currentColor"/></svg></button>
                            <button class="icon-btn" id="translate-btn-restart" onclick="restartTranslateModel()" title="restart"><svg width="10" height="10" viewBox="0 0 10 10"><path d="M5 1a4 4 0 1 0 4 4" stroke="currentColor" fill="none" stroke-width="1.5"/><path d="M7 1l2 4h-4z" fill="currentColor"/></svg></button>
                        </span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-translate">loading...</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="model-name-full" id="translate-model-name" style="display:none">-</div>
                        <div class="svc-stats">
                            <div>translations: <span id="translate-stat-total">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Image row -->
                <div class="service-row" id="svc-row-image" onclick="onServiceRowClick(event, 'image')">
                    <div class="service-row-header">
                        <div class="status-dot" id="image-status-dot"></div>
                        <span class="service-row-name">Image</span>
                    </div>
                    <div class="service-row-model" id="svc-model-short-image">z-image-turbo-8bit</div>
                    <div class="service-row-details" onclick="event.stopPropagation()">
                        <div class="svc-stats">
                            <div>Local mflux</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-content">
                <div class="mini-calendar" id="mini-calendar">
                    <div class="cal-nav">
                        <button onclick="calPrevMonth()">&lt;</button>
                        <span class="cal-month" id="cal-month-label"></span>
                        <button onclick="calNextMonth()">&gt;</button>
                    </div>
                    <div class="cal-grid" id="cal-grid"></div>
                </div>
            </div>
        </div>

        <div class="main">
            <!-- ASR main panel -->
            <div class="main-content asr-panel" id="asr-panel">
                <div class="header">
                    <h2>Transcripts</h2>
                    <div class="header-controls">
                        <div class="sort-controls">
                            <span class="sort-label">sort:</span>
                            <button class="sort-btn active" id="sort-time" onclick="setSort('time')">
                                time
                                <svg id="sort-time-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg>
                            </button>
                            <button class="sort-btn" id="sort-length" onclick="setSort('length')">
                                length
                                <svg id="sort-length-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg>
                            </button>
                            <button class="sort-btn" id="sort-latency" onclick="setSort('latency')">
                                latency
                                <svg id="sort-latency-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg>
                            </button>
                        </div>
                        <div class="speed-controls">
                            <span class="speed-label">speed:</span>
                            <button class="speed-btn" data-speed="1" onclick="setSpeed(1)">1x</button>
                            <button class="speed-btn active" data-speed="2" onclick="setSpeed(2)">2x</button>
                            <button class="speed-btn" data-speed="4" onclick="setSpeed(4)">4x</button>
                        </div>
                    </div>
                </div>
                <div id="transcripts"><div class="empty">select a date to view transcripts</div></div>
            </div>

            <!-- TTS main panel -->
            <div class="main-content tts-panel" id="tts-panel">
                <div class="tts-compose">
                    <div class="tts-compose-header">Synthesize Speech</div>
                    <textarea class="tts-textarea" id="tts-text" placeholder="Enter text to synthesize..."></textarea>
                    <div class="tts-controls">
                        <select class="tts-select" id="tts-voice-select">
                            <option value="Chelsie">Chelsie (EN/F)</option>
                            <option value="Ethan">Ethan (EN/M)</option>
                            <option value="Vivian">Vivian (ZH/F)</option>
                        </select>
                        <select class="tts-select" id="tts-lang-select">
                            <option value="en">English</option>
                            <option value="zh">Chinese</option>
                            <option value="ja">Japanese</option>
                            <option value="ko">Korean</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="es">Spanish</option>
                            <option value="ru">Russian</option>
                            <option value="it">Italian</option>
                            <option value="pt">Portuguese</option>
                        </select>
                        <label style="font-size:11px;color:#9ca3af;">speed:</label>
                        <input type="number" class="tts-speed-input" id="tts-speed" value="1.0" min="0.5" max="2.0" step="0.1">
                        <button class="synthesize-btn" id="synthesize-btn" onclick="synthesize()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                            <span id="synthesize-btn-text">Synthesize</span>
                        </button>
                    </div>
                </div>

                <div class="header" style="margin-top: 0;">
                    <h2>TTS History</h2>
                </div>
                <div id="tts-history"><div class="empty">no TTS history yet</div></div>
            </div>

            <!-- Translate main panel -->
            <div class="main-content translate-panel" id="translate-panel">
                <div class="translate-compose">
                    <div class="translate-compose-header">Translate Text</div>
                    <div class="translate-controls">
                        <select class="translate-select" id="translate-source-lang"></select>
                        <button class="swap-btn" onclick="swapLanguages()" title="Swap languages">&#8644;</button>
                        <select class="translate-select" id="translate-target-lang"></select>
                        <button class="synthesize-btn" id="translate-btn" onclick="doTranslate()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0014.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>
                            <span id="translate-btn-text">Translate</span>
                        </button>
                    </div>
                    <textarea class="translate-textarea" id="translate-input" placeholder="Enter text to translate..."></textarea>
                    <div class="translate-output-label">Translation</div>
                    <textarea class="translate-textarea" id="translate-output" placeholder="Translation will appear here..." readonly></textarea>
                </div>

                <div class="file-translate-section">
                    <div class="translate-compose-header">File Translation</div>
                    <div class="file-translate-controls">
                        <input type="text" class="file-input" id="translate-file-path" placeholder="File path (e.g. ~/Documents/input.txt)">
                        <select class="translate-select" id="translate-file-source"></select>
                        <select class="translate-select" id="translate-file-target"></select>
                        <button class="synthesize-btn" id="translate-file-btn" onclick="startFileTranslate()">
                            <span id="translate-file-btn-text">Start</span>
                        </button>
                    </div>
                    <div class="file-progress" id="translate-file-progress" style="display:none;">
                        <span id="translate-file-progress-text">0 / 0 lines</span>
                        <div class="file-progress-bar">
                            <div class="file-progress-fill" id="translate-file-progress-fill" style="width:0%"></div>
                        </div>
                    </div>
                </div>

                <div class="header" style="margin-top: 0;">
                    <h2>Translation History</h2>
                </div>
                <div id="translate-history"><div class="empty">no translation history yet</div></div>
            </div>
            
            <!-- Image main panel -->
            <div class="main-content image-panel" id="image-panel">
                <div class="image-compose">
                    <div class="translate-compose-header">Generate Image</div>
                    <textarea class="tts-textarea" id="image-prompt" placeholder="Enter prompt description..."></textarea>
                    <div class="tts-controls">
                        <select class="translate-select" id="image-resolution">
                            <option value="1024x1024" selected>1024x1024</option>
                            <option value="768x1024">768x1024</option>
                            <option value="1024x768">1024x768</option>
                            <option value="512x512">512x512</option>
                        </select>
                        <button class="synthesize-btn" id="image-gen-btn" onclick="generateImage()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            <span id="image-gen-btn-text">Generate</span>
                        </button>
                    </div>
                    <div class="image-result" id="image-result" style="display:none">
                        <!-- Result will appear here -->
                    </div>
                </div>
                
                <div class="header" style="margin-top: 0;">
                    <h2>Generation History</h2>
                </div>
                <div id="image-history"><div class="empty">no history yet</div></div>
            </div>
        </div>
    </div>
    <script>
        // ========== Shared state ==========
        let currentTab = 'asr';
        let currentAudio = null;

        // ========== ASR state ==========
        let currentDate = null;
        let lastRecordCount = 0;
        let knownDates = [];
        let currentSort = 'time';
        let sortAscending = false;
        let currentSpeed = 2;

        // ========== TTS state ==========
        let ttsCurrentDate = null;
        let ttsHistory = [];
        let ttsPaused = false;

        // ========== Translate state ==========
        let translatePaused = false;
        let translateLanguages = [];
        let translateFilePolling = null;
        
        // ========== Image state ==========
        let imageCurrentDate = null;

        // ========== Tab switching ==========
        // ========== Mini Calendar ==========
        let calYear, calMonth; // 0-indexed month
        let calAvailableDates = {}; // {service: Set of 'YYYY-MM-DD'}
        
        function initCalendar() {
            const now = new Date();
            calYear = now.getFullYear();
            calMonth = now.getMonth();
            renderCalendar();
        }
        
        function calPrevMonth() {
            calMonth--;
            if (calMonth < 0) { calMonth = 11; calYear--; }
            renderCalendar();
        }
        
        function calNextMonth() {
            calMonth++;
            if (calMonth > 11) { calMonth = 0; calYear++; }
            renderCalendar();
        }
        
        function renderCalendar() {
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            document.getElementById('cal-month-label').textContent = months[calMonth] + ' ' + calYear;
            
            const grid = document.getElementById('cal-grid');
            const headers = ['Mo','Tu','We','Th','Fr','Sa','Su'];
            let html = headers.map(h => '<div class="cal-header">' + h + '</div>').join('');
            
            const firstDay = new Date(calYear, calMonth, 1);
            let startDay = firstDay.getDay() - 1; // Monday = 0
            if (startDay < 0) startDay = 6;
            const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
            const today = new Date().toISOString().slice(0, 10);
            const dates = calAvailableDates[currentTab] || new Set();
            
            for (let i = 0; i < startDay; i++) html += '<div class="cal-day"></div>';
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = calYear + '-' + String(calMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                const hasData = dates.has(dateStr);
                const isActive = (currentTab === 'asr' && dateStr === currentDate) ||
                                 (currentTab === 'tts' && dateStr === ttsCurrentDate) ||
                                 (currentTab === 'image' && dateStr === imageCurrentDate);
                const isToday = dateStr === today;
                let cls = 'cal-day';
                if (hasData) cls += ' has-data';
                if (isActive) cls += ' active';
                if (isToday) cls += ' today';
                const onclick = hasData ? ' onclick="calSelectDate(\'' + dateStr + '\')"' : '';
                html += '<div class="' + cls + '"' + onclick + '>' + d + '</div>';
            }
            grid.innerHTML = html;
        }
        
        function calSelectDate(dateStr) {
            if (currentTab === 'asr') {
                currentDate = dateStr;
                loadTranscripts(dateStr);
            } else if (currentTab === 'tts') {
                ttsCurrentDate = dateStr;
                loadTTSHistoryForDate(dateStr);
            } else if (currentTab === 'translate') {
                loadTranslateHistoryForDate(dateStr);
            } else if (currentTab === 'image') {
                imageCurrentDate = dateStr;
                loadImageHistoryForDate(dateStr);
            }
            renderCalendar();
        }
        
        async function loadCalendarDates(service) {
            try {
                if (service === 'asr') {
                    const res = await fetch('/api/dates');
                    const dates = await res.json();
                    calAvailableDates.asr = new Set(dates);
                } else if (service === 'tts') {
                    const res = await fetch('/api/tts/history');
                    const data = await res.json();
                    calAvailableDates.tts = new Set(data.map(r => r.date));
                } else if (service === 'translate') {
                    const res = await fetch('/api/translate/history');
                    const data = await res.json();
                    calAvailableDates.translate = new Set(data.map(r => r.date));
                } else if (service === 'image') {
                    const res = await fetch('/api/image/history');
                    const data = await res.json();
                    calAvailableDates.image = new Set(data.map(r => r.date));
                }
            } catch(e) {
                calAvailableDates[service] = new Set();
            }
            renderCalendar();
        }

        function switchTab(tab) {
            currentTab = tab;

            // Update service row active state
            ['asr', 'tts', 'translate', 'image'].forEach(t => {
                const row = document.getElementById('svc-row-' + t);
                row.classList.toggle('active', t === tab);
            });

            // Update main panels
            document.getElementById('asr-panel').style.display = tab === 'asr' ? 'block' : 'none';
            document.getElementById('tts-panel').style.display = tab === 'tts' ? 'block' : 'none';
            document.getElementById('translate-panel').style.display = tab === 'translate' ? 'block' : 'none';
            document.getElementById('image-panel').style.display = tab === 'image' ? 'block' : 'none';

            // Refresh calendar for this service
            loadCalendarDates(tab);

            if (tab === 'tts') {
                loadTTSHistory();
                loadTTSStatus();
            }
            if (tab === 'translate') {
                loadTranslateLanguages();
                loadTranslateStatus();
                loadTranslateHistory();
            }
            if (tab === 'image') {
                loadImageStatus();
                loadImageHistory();
            }
        }

        function onServiceRowClick(event, tab) {
            // Collapse all other rows, expand the clicked one
            document.querySelectorAll('.service-row').forEach(r => {
                if (r.id === 'svc-row-' + tab) {
                    r.classList.add('active', 'expanded');
                } else {
                    r.classList.remove('active', 'expanded');
                }
            });
            // Switch main content
            switchTab(tab);
        }

        // ========== ASR functions ==========

        function setSpeed(speed) {
            currentSpeed = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.speed) === speed);
            });
            if (currentAudio) {
                currentAudio.playbackRate = speed;
            }
        }

        async function loadDates() {
            const res = await fetch('/api/dates');
            const dates = await res.json();

            const hadNewDate = dates.length > knownDates.length;
            knownDates = dates;
            
            // Update calendar
            calAvailableDates.asr = new Set(dates);
            renderCalendar();

            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

            try {
                const todayRes = await fetch(`/api/transcripts/${today}`);
                if (todayRes.ok) {
                    const todayRecords = await todayRes.json();
                    document.getElementById('stat-today').textContent = todayRecords.length + ' items';
                    const todayDuration = todayRecords.reduce((sum, r) => sum + (r.audio_duration_ms || 0), 0);
                    document.getElementById('stat-today-duration').textContent = formatDurationHHMM(todayDuration);
                } else {
                    document.getElementById('stat-today').textContent = '0 items';
                    document.getElementById('stat-today-duration').textContent = '00:00';
                }
            } catch (e) {
                document.getElementById('stat-today').textContent = '0 items';
                document.getElementById('stat-today-duration').textContent = '00:00';
            }

            let totalDuration = 0;
            for (const date of dates) {
                try {
                    const res = await fetch(`/api/transcripts/${date}`);
                    if (res.ok) {
                        const records = await res.json();
                        totalDuration += records.reduce((sum, r) => sum + (r.audio_duration_ms || 0), 0);
                    }
                } catch (e) {}
            }
            document.getElementById('stat-total-duration').textContent = formatDurationHHMM(totalDuration);

            if (dates.includes(today)) {
                loadTranscripts(today);
            } else if (!currentDate || hadNewDate) {
                loadTranscripts(dates[0]);
            }

            document.getElementById('stat-total').textContent = dates.length + ' days';
        }

        async function loadTranscripts(date) {
            currentDate = date;
            document.querySelectorAll('#dates .date-item').forEach(el => {
                el.classList.toggle('active', el.dataset.date === date);
            });
            const res = await fetch(`/api/transcripts/${date}`);
            const records = await res.json();
            const container = document.getElementById('transcripts');

            const hadNewRecords = records.length > lastRecordCount;
            lastRecordCount = records.length;

            const now = new Date(); const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            if (date === today) {
                document.getElementById('stat-today').textContent = records.length + ' items';
            }

            if (records.length === 0) {
                container.innerHTML = '<div class="empty">no transcripts for this date</div>';
                return;
            }

            const sortedRecords = sortRecords(records);

            container.innerHTML = sortedRecords.map((r, i) => {
                const time = new Date(r.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                const latency = (r.latency_ms || r.duration_ms || 0) / 1000;
                const audioLen = (r.audio_duration_ms || 0) / 1000;
                const model = r.model || 'unknown';
                return `
                    <div class="transcript" data-audio-url="/audio/${date}/${r.audio_file}">
                        <div class="transcript-header">
                            <span class="transcript-time">${time}</span>
                            <span class="transcript-latency">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="12" cy="13" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 9v4l2.5 2.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <circle cx="10" cy="12" r="0.8"/><circle cx="14" cy="12" r="0.8"/>
                                    <path d="M10 15.5q2 1.5 4 0" fill="none" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
                                    <rect x="10" y="3" width="4" height="2" rx="0.5"/>
                                </svg>
                                ${latency.toFixed(1)}s
                            </span>
                            <span class="transcript-model">${model}</span>
                        </div>
                        <div class="transcript-text">${escapeHtml(r.text)}</div>
                        <div class="waveform-container" onclick="seekAudio(event, this)">
                            <canvas></canvas>
                            <div class="waveform-progress"></div>
                            <div class="waveform-time">0:00 / ${audioLen.toFixed(1)}s</div>
                            <div class="waveform-loading">loading waveform...</div>
                        </div>
                        <div class="transcript-footer">
                            <span class="transcript-file">${r.audio_file}</span>
                            <button class="play-btn" onclick="toggleAudio(this)">
                                <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                <span class="btn-text">play</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.transcript').forEach(el => loadWaveform(el));

            if (hadNewRecords) {
                container.scrollTop = container.scrollHeight;
            }
        }

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const waveformCache = new Map();

        async function loadWaveform(transcriptEl) {
            const url = transcriptEl.dataset.audioUrl;
            const container = transcriptEl.querySelector('.waveform-container');
            const canvas = container.querySelector('canvas');
            const loading = container.querySelector('.waveform-loading');
            const timeDisplay = container.querySelector('.waveform-time');

            try {
                let waveformData = waveformCache.get(url);
                let duration = 0;
                if (!waveformData) {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    waveformData = extractWaveform(audioBuffer, 100);
                    waveformData.duration = audioBuffer.duration;
                    waveformCache.set(url, waveformData);
                }
                duration = waveformData.duration || 0;
                if (duration > 0) {
                    timeDisplay.textContent = '0:00 / ' + duration.toFixed(1) + 's';
                }
                drawWaveform(canvas, waveformData, 0);
                loading.style.display = 'none';
            } catch (e) {
                loading.textContent = 'waveform unavailable';
            }
        }

        function extractWaveform(audioBuffer, samples) {
            const channelData = audioBuffer.getChannelData(0);
            const blockSize = Math.floor(channelData.length / samples);
            const waveform = [];
            for (let i = 0; i < samples; i++) {
                let sum = 0;
                for (let j = 0; j < blockSize; j++) {
                    sum += Math.abs(channelData[i * blockSize + j]);
                }
                waveform.push(sum / blockSize);
            }
            const max = Math.max(...waveform);
            return waveform.map(v => v / max);
        }

        function drawWaveform(canvas, data, progress) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.height;
            const barWidth = width / data.length;
            const gap = 1;

            ctx.clearRect(0, 0, width, height);

            data.forEach((val, i) => {
                const x = i * barWidth;
                const barHeight = val * height * 0.8;
                const y = (height - barHeight) / 2;
                
                if (i / data.length < progress) {
                    ctx.fillStyle = '#e25f4a';
                } else {
                    ctx.fillStyle = '#d0d5dd';
                }
                
                ctx.fillRect(x, y, barWidth - gap, barHeight);
            });
        }

        function toggleAudio(btn) {
            const transcriptEl = btn.closest('.transcript');
            const url = transcriptEl.dataset.audioUrl;
            const container = transcriptEl.querySelector('.waveform-container');
            const canvas = container.querySelector('canvas');
            const progressEl = container.querySelector('.waveform-progress');
            
            // If clicking the currently playing audio
            if (currentAudio && currentAudio.src.endsWith(url)) {
                if (currentAudio.paused) {
                    currentAudio.play();
                    btn.querySelector('.icon-play').style.display = 'none';
                    btn.querySelector('.icon-pause').style.display = 'block';
                    btn.querySelector('.btn-text').textContent = 'pause';
                } else {
                    currentAudio.pause();
                    btn.querySelector('.icon-play').style.display = 'block';
                    btn.querySelector('.icon-pause').style.display = 'none';
                    btn.querySelector('.btn-text').textContent = 'play';
                }
                return;
            }

            // Stop previous audio
            if (currentAudio) {
                currentAudio.pause();
                document.querySelectorAll('.play-btn').forEach(b => {
                    b.querySelector('.icon-play').style.display = 'block';
                    b.querySelector('.icon-pause').style.display = 'none';
                    b.querySelector('.btn-text').textContent = 'play';
                });
                // Reset waveforms
                document.querySelectorAll('.waveform-container canvas').forEach(c => {
                   const tEl = c.closest('.transcript');
                   const u = tEl.dataset.audioUrl;
                   const wd = waveformCache.get(u);
                   if (wd) drawWaveform(c, wd, 0); 
                });
            }

            currentAudio = new Audio(url);
            currentAudio.playbackRate = currentSpeed;
            
            currentAudio.addEventListener('timeupdate', () => {
                const progress = currentAudio.currentTime / currentAudio.duration;
                // Update progress bar width is actually handled by redrawing canvas now
                const wd = waveformCache.get(url);
                if (wd) drawWaveform(canvas, wd, progress);
                
                const cur = formatTime(currentAudio.currentTime);
                const tot = formatTime(currentAudio.duration);
                container.querySelector('.waveform-time').textContent = `${cur} / ${tot}`;
            });

            currentAudio.addEventListener('ended', () => {
                btn.querySelector('.icon-play').style.display = 'block';
                btn.querySelector('.icon-pause').style.display = 'none';
                btn.querySelector('.btn-text').textContent = 'play';
                const wd = waveformCache.get(url);
                if (wd) drawWaveform(canvas, wd, 0);
                container.querySelector('.waveform-time').textContent = `0:00 / ${formatTime(currentAudio.duration)}`;
                currentAudio = null;
            });

            currentAudio.play();
            btn.querySelector('.icon-play').style.display = 'none';
            btn.querySelector('.icon-pause').style.display = 'block';
            btn.querySelector('.btn-text').textContent = 'pause';
        }

        function seekAudio(e, container) {
            if (!currentAudio) {
                // If not playing, start playing
                const btn = container.closest('.transcript').querySelector('.play-btn');
                toggleAudio(btn);
            }
            
            // Check if this container matches current audio
            const url = container.closest('.transcript').dataset.audioUrl;
            if (!currentAudio.src.endsWith(url)) {
                 const btn = container.closest('.transcript').querySelector('.play-btn');
                 toggleAudio(btn);
            }

            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const progress = x / rect.width;
            if (currentAudio && currentAudio.duration) {
                currentAudio.currentTime = progress * currentAudio.duration;
            }
        }

        // ========== Helper functions ==========
        function formatDurationHHMM(ms) {
            const sec = Math.floor(ms / 1000);
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            if (h > 0) {
                return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            }
            return `${m}:${String(s).padStart(2,'0')}`;
        }

        function formatTime(s) {
            if (!s) return '0:00';
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${String(sec).padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function sortRecords(records) {
            return records.sort((a, b) => {
                let valA, valB;
                if (currentSort === 'time') {
                    valA = new Date(a.timestamp);
                    valB = new Date(b.timestamp);
                } else if (currentSort === 'length') {
                    valA = a.audio_duration_ms || 0;
                    valB = b.audio_duration_ms || 0;
                } else if (currentSort === 'latency') {
                    valA = a.latency_ms || 0;
                    valB = b.latency_ms || 0;
                }

                if (sortAscending) {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });
        }

        function setSort(type) {
            if (currentSort === type) {
                sortAscending = !sortAscending;
            } else {
                currentSort = type;
                sortAscending = false;
            }

            // Update UI
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('sort-' + type).classList.add('active');
            
            const icon = document.getElementById('sort-' + type + '-icon');
            icon.style.transform = sortAscending ? 'rotate(180deg)' : 'rotate(0deg)';

            if (currentDate) loadTranscripts(currentDate);
        }

        function togglePause() {
            // Placeholder - actual API call needed
            // For now just toggle UI
            const dot = document.getElementById('status-dot');
            dot.classList.toggle('paused');
        }

        function restartModel() {
            fetch('/api/server/restart', {method: 'POST'})
                .then(res => res.json())
                .then(data => alert('Model restarted: ' + data.model));
        }

        async function switchModel(model) {
            const res = await fetch('/api/model/switch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model})
            });
            const data = await res.json();
            document.getElementById('svc-model-short-asr').textContent = data.model.split('/').pop();
        }

        // ========== TTS functions ==========
        
        async function loadTTSStatus() {
            const res = await fetch('/api/tts/status');
            const status = await res.json();
            
            document.getElementById('svc-model-short-tts').textContent = status.model_short;
            document.getElementById('tts-model-name').textContent = status.model;
            
            const dot = document.getElementById('tts-status-dot');
            dot.className = 'status-dot';
            if (status.paused) dot.classList.add('paused');
            if (status.loading) dot.classList.add('loading');
            
            // Populate models
            const select = document.getElementById('tts-model-select');
            select.innerHTML = status.available_models.map(m => 
                `<option value="${m}" ${m === status.model ? 'selected' : ''}>${m.split('/').pop()}</option>`
            ).join('');

            // Populate voices
            const vRes = await fetch('/api/tts/voices');
            const voices = await vRes.json();
            const vSelect = document.getElementById('tts-voice-select');
            vSelect.innerHTML = voices.map(v => 
                `<option value="${v.id}">${v.name} (${v.language})</option>`
            ).join('');
        }

        async function loadTTSHistory() {
            const res = await fetch('/api/tts/history');
            const records = await res.json();
            document.getElementById('tts-stat-total').textContent = records.length;
            
            renderTTSHistory(records);
        }

        async function loadTTSHistoryForDate(date) {
            const res = await fetch(`/api/tts/history/${date}`);
            const records = await res.json();
            renderTTSHistory(records);
        }

        function renderTTSHistory(records) {
            const container = document.getElementById('tts-history');
            if (!records.length) {
                container.innerHTML = '<div class="empty">no TTS history</div>';
                return;
            }
            
            container.innerHTML = records.map(r => {
                const time = new Date(r.timestamp).toLocaleTimeString();
                const latency = (r.latency_ms / 1000).toFixed(1);
                
                return `
                <div class="tts-item" data-audio-url="/tts_audio/${r.audio_file}">
                    <div class="transcript-header">
                        <span class="transcript-time">${time}</span>
                        <span class="tts-voice-badge">${r.voice}</span>
                        <span class="tts-lang-badge">${r.language}</span>
                        <span class="transcript-latency">${latency}s</span>
                    </div>
                    <div class="transcript-text">${escapeHtml(r.text)}</div>
                    <div class="waveform-container" onclick="seekAudio(event, this)">
                        <canvas></canvas>
                        <div class="waveform-progress"></div>
                        <div class="waveform-time">0:00 / ${(r.audio_duration_ms/1000).toFixed(1)}s</div>
                    </div>
                    <div class="transcript-footer">
                        <button class="play-btn" onclick="toggleAudio(this)">
                            <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            <span class="btn-text">play</span>
                        </button>
                        <a href="/tts_audio/${r.audio_file}" download class="icon-btn" style="margin-left:auto;width:auto;padding:0 8px;font-size:11px;">download</a>
                    </div>
                </div>`;
            }).join('');
            
            document.querySelectorAll('.tts-item').forEach(el => loadWaveform(el));
        }

        async function synthesize() {
            const text = document.getElementById('tts-text').value;
            const voice = document.getElementById('tts-voice-select').value;
            const lang = document.getElementById('tts-lang-select').value;
            const speed = parseFloat(document.getElementById('tts-speed').value);
            
            const btn = document.getElementById('synthesize-btn');
            const btnText = document.getElementById('synthesize-btn-text');
            btn.disabled = true;
            btnText.textContent = 'Generating...';
            
            try {
                const res = await fetch('/synthesize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text, voice, language: lang, speed})
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                const data = await res.json();
                loadTTSHistory(); // Refresh list
                
            } catch(e) {
                alert('TTS failed: ' + e.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Synthesize';
            }
        }
        
        async function switchTTSModel(model) {
            await fetch('/api/tts/model/switch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model})
            });
            loadTTSStatus();
        }
        
        function toggleTTSPause() {
            const action = ttsPaused ? 'resume' : 'pause';
            fetch(`/api/tts/server/${action}`, {method: 'POST'})
                .then(() => {
                    ttsPaused = !ttsPaused;
                    loadTTSStatus();
                });
        }
        
        // ========== Translate functions ==========
        
        async function loadTranslateStatus() {
            const res = await fetch('/api/translate/status');
            const status = await res.json();
            
            document.getElementById('svc-model-short-translate').textContent = 'TranslateGemma';
            document.getElementById('translate-model-name').textContent = status.model;
            
            const dot = document.getElementById('translate-status-dot');
            dot.className = 'status-dot';
            if (status.paused) dot.classList.add('paused');
            if (status.loading) dot.classList.add('loading');
        }

        async function loadTranslateLanguages() {
            if (translateLanguages.length > 0) return;
            const res = await fetch('/languages');
            const data = await res.json();
            translateLanguages = data.data.languages;
            
            const opts = translateLanguages.map(l => `<option value="${l.language}">${l.name}</option>`).join('');
            document.getElementById('translate-source-lang').innerHTML = opts;
            document.getElementById('translate-target-lang').innerHTML = opts;
            document.getElementById('translate-file-source').innerHTML = opts;
            document.getElementById('translate-file-target').innerHTML = opts;
            
            // Defaults
            document.getElementById('translate-source-lang').value = 'en';
            document.getElementById('translate-target-lang').value = 'zh';
            document.getElementById('translate-file-source').value = 'en';
            document.getElementById('translate-file-target').value = 'zh';
        }

        async function doTranslate() {
            const q = document.getElementById('translate-input').value;
            const source = document.getElementById('translate-source-lang').value;
            const target = document.getElementById('translate-target-lang').value;
            const btn = document.getElementById('translate-btn');
            const btnText = document.getElementById('translate-btn-text');
            
            if (!q.trim()) return;
            
            btn.disabled = true;
            btnText.textContent = 'Translating...';
            
            try {
                const res = await fetch('/translate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({q, source, target})
                });
                const data = await res.json();
                document.getElementById('translate-output').value = data.data.translations[0].translatedText;
                loadTranslateHistory();
            } catch(e) {
                alert('Translate failed: ' + e.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Translate';
            }
        }
        
        function swapLanguages() {
            const s = document.getElementById('translate-source-lang');
            const t = document.getElementById('translate-target-lang');
            const temp = s.value;
            s.value = t.value;
            t.value = temp;
        }

        async function loadTranslateHistory() {
            const res = await fetch('/api/translate/history');
            const records = await res.json();
            document.getElementById('translate-stat-total').textContent = records.length;
            renderTranslateHistory(records);
        }
        
        async function loadTranslateHistoryForDate(date) {
            // Filter client side as endpoint returns all for now (or implement date filter on server)
            // For now reusing all history endpoint and filtering
            const res = await fetch('/api/translate/history');
            let records = await res.json();
            records = records.filter(r => r.timestamp.startsWith(date));
            renderTranslateHistory(records);
        }

        function renderTranslateHistory(records) {
            const container = document.getElementById('translate-history');
            if (!records.length) {
                container.innerHTML = '<div class="empty">no translation history</div>';
                return;
            }
            
            container.innerHTML = records.map(r => {
                const time = new Date(r.timestamp).toLocaleTimeString();
                return `
                <div class="translate-item">
                    <div class="transcript-header">
                        <span class="transcript-time">${time}</span>
                        <span class="translate-lang-badge">${r.source_lang}</span>
                        <span class="translate-arrow"></span>
                        <span class="translate-lang-badge">${r.target_lang}</span>
                    </div>
                    <div class="translate-source-text">${escapeHtml(r.source_text)}</div>
                    <div class="translate-result-text">${escapeHtml(r.translated_text)}</div>
                </div>`;
            }).join('');
        }
        
        async function startFileTranslate() {
            const file = document.getElementById('translate-file-path').value;
            const source = document.getElementById('translate-file-source').value;
            const target = document.getElementById('translate-file-target').value;
            
            if (!file) return;
            
            try {
                const res = await fetch('/translate/file', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({file, source, target})
                });
                const data = await res.json();
                if (data.status === 'started') {
                    pollFileTranslate(data.output);
                }
            } catch(e) {
                alert('File translate error: ' + e.message);
            }
        }
        
        function pollFileTranslate(output) {
            const progressEl = document.getElementById('translate-file-progress');
            progressEl.style.display = 'block';
            
            if (translateFilePolling) clearInterval(translateFilePolling);
            
            translateFilePolling = setInterval(async () => {
                const res = await fetch(`/translate/file/status?output=${encodeURIComponent(output)}`);
                const status = await res.json();
                
                const pct = status.lines ? (status.done / status.lines * 100) : 0;
                document.getElementById('translate-file-progress-fill').style.width = pct + '%';
                document.getElementById('translate-file-progress-text').textContent = 
                    `${status.done} / ${status.lines} lines (${status.status})`;
                
                if (status.status !== 'running') {
                    clearInterval(translateFilePolling);
                }
            }, 1000);
        }

        function toggleTranslatePause() {
            const action = translatePaused ? 'resume' : 'pause';
            fetch(`/api/translate/server/${action}`, {method: 'POST'})
                .then(() => {
                    translatePaused = !translatePaused;
                    loadTranslateStatus();
                });
        }
        
        // ========== Image functions ==========
        
        async function loadImageStatus() {
            const res = await fetch('/api/image/status');
            const status = await res.json();
            
            const dot = document.getElementById('image-status-dot');
            dot.className = 'status-dot';
            if (status.available) {
                // green
            } else {
                dot.classList.add('error');
            }
        }
        
        async function generateImage() {
            const prompt = document.getElementById('image-prompt').value;
            const resolution = document.getElementById('image-resolution').value;
            
            if (!prompt.trim()) return;
            
            const btn = document.getElementById('image-gen-btn');
            const btnText = document.getElementById('image-gen-btn-text');
            const resultDiv = document.getElementById('image-result');
            
            btn.disabled = true;
            btnText.textContent = 'Generating...';
            resultDiv.style.display = 'none';
            resultDiv.innerHTML = '';
            
            try {
                const res = await fetch('/api/image/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({prompt, resolution, steps: 4})
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                const data = await res.json();
                
                resultDiv.innerHTML = `<img src="${data.image_url}" alt="Generated Image">
                    <div style="font-size:11px;color:#9ca3af;margin-top:4px;">${data.resolution} | ${(data.latency_ms/1000).toFixed(1)}s | steps ${data.steps}${data.seed != null ? ' | seed '+data.seed : ''}</div>`;
                resultDiv.style.display = 'block';
                
                loadImageHistory();
                
            } catch(e) {
                alert('Image gen failed: ' + e.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Generate';
            }
        }
        
        async function loadImageHistory() {
            const res = await fetch('/api/image/history');
            const records = await res.json();
            renderImageHistory(records);
        }
        
        async function loadImageHistoryForDate(date) {
            const res = await fetch('/api/image/history');
            let records = await res.json();
            records = records.filter(r => r.timestamp.startsWith(date));
            renderImageHistory(records);
        }
        
        function renderImageHistory(records) {
            const container = document.getElementById('image-history');
            if (!records.length) {
                container.innerHTML = '<div class="empty">no image history</div>';
                return;
            }
            
            container.innerHTML = records.map(r => {
                const time = new Date(r.timestamp).toLocaleTimeString();
                const latency = (r.latency_ms / 1000).toFixed(1);
                const imageUrl = `/image_output/${r.image_file}`;
                
                return `
                <div class="image-item">
                    <img src="${imageUrl}" class="image-item-thumb" onclick="window.open('${imageUrl}', '_blank')">
                    <div class="image-item-details">
                        <div class="transcript-header">
                            <span class="transcript-time">${time}</span>
                            <span class="translate-lang-badge">${r.resolution}</span>
                            <span class="transcript-latency">${latency}s</span>
                        </div>
                        <div class="image-item-prompt">${escapeHtml(r.prompt)}</div>
                        <div class="transcript-footer">
                            <a href="${imageUrl}" download class="icon-btn" style="width:auto;padding:0 8px;font-size:11px;">download</a>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // Init - load all service statuses on page load
        async function initServiceStatuses() {
            try {
                // ASR status
                const asrRes = await fetch('/health');
                const health = await asrRes.json();
                if (health.loaded) {
                    document.getElementById('svc-model-short-asr').textContent = health.model.split('/').pop();
                    document.getElementById('status-dot').className = 'status-dot';
                }
                // TTS status
                if (health.tts_loaded) {
                    document.getElementById('svc-model-short-tts').textContent = health.tts_model.split('/').pop();
                    document.getElementById('tts-status-dot').className = 'status-dot';
                }
                // Translate status
                if (health.translate_loaded) {
                    document.getElementById('svc-model-short-translate').textContent = 'TranslateGemma';
                    document.getElementById('translate-status-dot').className = 'status-dot';
                }
                // Image status
                if (health.image_loaded) {
                    document.getElementById('svc-model-short-image').textContent = health.image_model;
                    document.getElementById('image-status-dot').className = 'status-dot';
                }
            } catch(e) { console.log('status fetch error', e); }
        }
        loadDates();
        initCalendar();
        initServiceStatuses();
    </script>
</body>
</html>